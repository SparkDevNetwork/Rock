// <copyright>
// Copyright by the Spark Development Network
//
// Licensed under the Rock Community License (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
// http://www.rockrms.com/license
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.
// </copyright>

using System;
using System.Diagnostics;
using System.Linq;
using Microsoft.VisualStudio.TestTools.UnitTesting;
using Rock.Data;
using Rock.Lava;
using Rock.Model;
using Rock.Lava.Fluid;
using Rock.Tests.Shared;
using Rock.Utility.Settings;
using Rock.Web.Cache;
using System.Collections.Generic;
using Rock.Lava.RockLiquid;

namespace Rock.Tests.Integration.Lava
{
    /// <summary>
    /// Tests for Lava Filters categorized as "Miscellaneous".
    /// </summary>
    /// <remarks>
    /// These tests require the standard Rock sample data set to be present in the target database.
    /// </remarks>
    [TestClass]
    public class MiscellaneousFilterTests : LavaIntegrationTestBase
    {
        [ClassInitialize]
        public static void Initialize( TestContext context )
        {
            var rockContext = new RockContext();

            // Add Followings for Ted Decker.
            var followingService = new FollowingService( rockContext );

            var tedDeckerGuid = TestGuids.TestPeople.TedDecker.AsGuid();
            var benJonesGuid = TestGuids.TestPeople.BenJones.AsGuid();
            var billMarbleGuid = TestGuids.TestPeople.BillMarble.AsGuid();

            var personService = new PersonService( rockContext );

            var tedDeckerAliasId = personService.Get( tedDeckerGuid ).PrimaryAliasId.GetValueOrDefault();

            var personEntityTypeId = EntityTypeCache.GetId( SystemGuid.EntityType.PERSON ).GetValueOrDefault();

            followingService.GetOrAddFollowing( personEntityTypeId, personService.Get( benJonesGuid ).Id, tedDeckerAliasId, null );
            followingService.GetOrAddFollowing( personEntityTypeId, personService.Get( billMarbleGuid ).Id, tedDeckerAliasId, null );

            rockContext.SaveChanges();

            // Add a Persisted Dataset containing some test people.
            var datasetLava = @"
[
{%- person where:'Guid == `<benJonesGuid>` || Guid == `<billMarbleGuid>` || Guid == `<alishaMarbleGuid>`' iterator:'People' -%}
  {%- for item in People -%}
    {
        `Id`: {{ item.Id | ToJSON }},
        `FirstName`: {{ item.NickName | ToJSON }},
        `LastName`: {{ item.LastName | ToJSON }},
        `FullName`: {{ item.FullName | ToJSON }},
    }
    {%- unless forloop.last -%},{%- endunless -%}
  {%- endfor -%}
{%- endperson -%}
]
";

            datasetLava = datasetLava.Replace( "<benJonesGuid>", TestGuids.TestPeople.BenJones )
                .Replace( "<billMarbleGuid>", TestGuids.TestPeople.BillMarble )
                .Replace( "<alishaMarbleGuid>", TestGuids.TestPeople.AlishaMarble );

            // Create a Persisted Dataset.
            const string PersistedDataSetPeopleGuid = "99FF9EFA-D9E3-48DE-AD08-C67389FF688F";

            datasetLava = datasetLava.Replace( "`", @"""" );

            var ps = new PersistedDatasetService( rockContext );

            var pds = ps.Get( PersistedDataSetPeopleGuid.AsGuid() );

            if ( pds == null )
            {
                pds = new PersistedDataset();

                pds.Guid = PersistedDataSetPeopleGuid.AsGuid();

                ps.Add( pds );
            }

            pds.Name = "Persons";
            pds.AccessKey = "persons";
            pds.Description = "A persisted dataset created for testing purposes.";
            pds.BuildScriptType = PersistedDatasetScriptType.Lava;
            pds.BuildScript = datasetLava;
            pds.EnabledLavaCommands = "RockEntity";
            pds.EntityTypeId = EntityTypeCache.Get( typeof( Person ), createIfNotFound: false, rockContext ).Id;

            pds.UpdateResultData();

            rockContext.SaveChanges();
        }

        #region Debug

        [TestMethod]
        public void DebugFilter_WithLavaParameter_ReturnsDebugInfo()
        {
            var template = "{{ 'Lava' | Debug }}";

            // Verify a portion of the expected output.
            TestHelper.AssertTemplateOutput( "<li><span class='lava-debug-key'>OrganizationName</span> <span class='lava-debug-value'> - Rock Solid Church</span></li>",
                template,
                new LavaTestRenderOptions { OutputMatchType = LavaTestOutputMatchTypeSpecifier.Contains } );
        }

        #endregion

        #region RockInstanceConfigFilter

        [TestMethod]
        public void RockInstanceConfigFilter_MachineName_RendersExpectedValue()
        {
            var template = "{{ 'MachineName' | RockInstanceConfig }}";
            var expectedValue = RockInstanceConfig.MachineName;

            TestHelper.AssertTemplateOutput( expectedValue, template );
        }

        [TestMethod]
        public void RockInstanceConfigFilter_ApplicationDirectory_RendersExpectedValue()
        {
            var template = "{{ 'ApplicationDirectory' | RockInstanceConfig }}";
            var expectedValue = RockInstanceConfig.ApplicationDirectory;

            TestHelper.AssertTemplateOutput( expectedValue, template );
        }

        [TestMethod]
        public void RockInstanceConfigFilter_PhysicalDirectory_RendersExpectedValue()
        {
            var template = "{{ 'PhysicalDirectory' | RockInstanceConfig }}";
            var expectedValue = RockInstanceConfig.PhysicalDirectory;

            TestHelper.AssertTemplateOutput( expectedValue, template );
        }

        [TestMethod]
        public void RockInstanceConfigFilter_IsClustered_RendersExpectedValue()
        {
            var template = "{{ 'IsClustered' | RockInstanceConfig }}";
            var expectedValue = RockInstanceConfig.IsClustered.ToTrueFalse();

            TestHelper.AssertTemplateOutput( expectedValue, template, new LavaTestRenderOptions { IgnoreCase = true } );
        }

        [TestMethod]
        public void RockInstanceConfigFilter_SystemDateTime_RendersExpectedValue()
        {
            var template = "{{ 'SystemDateTime' | RockInstanceConfig | Date:'yyyy-MM-dd HH:mm:ss' }}";
            var expectedValue = RockInstanceConfig.SystemDateTime;

            TestHelper.ExecuteForActiveEngines( ( engine ) =>
            {
                var result = engine.RenderTemplate( template );

                var actualDateTime = result.Text.AsDateTime();

                if ( actualDateTime == null )
                {
                    throw new System.Exception( $"Invalid DateTime - Output = \"{result.Text}\"" );
                }

                TestHelper.DebugWriteRenderResult( engine, template, result.Text );

                Assert.That.AreProximate( expectedValue, actualDateTime, new System.TimeSpan( 0, 0, 30 ) );
            } );
        }

        [TestMethod]
        public void RockInstanceConfigFilter_LavaEngine_RendersExpectedValue()
        {
            var template = "{{ 'LavaEngine' | RockInstanceConfig }}";

            TestHelper.ExecuteForActiveEngines( ( engine ) =>
            {
                var result = engine.RenderTemplate( template );

                TestHelper.DebugWriteRenderResult( engine, template, result.Text );

                var expectedOutput = RockInstanceConfig.LavaEngineName;

                Assert.That.AreEqual( expectedOutput, result.Text );
            } );
        }

        [TestMethod]
        public void RockInstanceConfigFilter_InvalidParameterName_RendersErrorMessage()
        {
            var template = "{{ 'unknown_setting' | RockInstanceConfig }}";
            var expectedOutput = "Configuration setting \"unknown_setting\" is not available.";

            TestHelper.AssertTemplateOutput( expectedOutput, template );
        }

        #endregion

        #region LavaLibraryTestFilters

        /// <summary>
        /// Registering a filter with an invalid parameter type correctly throws a Lava exception.
        /// </summary>
        [TestMethod]
        [Ignore( "The restriction on parameter types for Fluid has been removed." )]
        public void Fluid_MismatchedFilterParameters_ShowsCorrectErrorMessage()
        {
            if ( !LavaIntegrationTestHelper.FluidEngineIsEnabled )
            {
                Debug.Write( "The Fluid engine is not enabled for this test run." );
                return;
            }

            var inputTemplate = @"
{{ '1' | AppendValue:'2' }}
";

            var expectedOutput = @"12";

            var engine = TestHelper.GetEngineInstance( typeof( FluidEngine ) );

            // Filters are registered
            var filterMethodValid = typeof( TestLavaLibraryFilter ).GetMethod( "AppendString", new System.Type[] { typeof( object ), typeof( string ) } );
            var filterMethodInvalid = typeof( TestLavaLibraryFilter ).GetMethod( "AppendGuid", new System.Type[] { typeof( object ), typeof( Guid ) } );

            engine.RegisterFilter( filterMethodValid, "AppendValue" );

            // This should render correctly.
            TestHelper.AssertTemplateOutput( engine, expectedOutput, inputTemplate );

            // This should throw an exception when attempting to render a template containing the invalid filter.
            engine.RegisterFilter( filterMethodInvalid, "AppendValue" );

            var result = engine.RenderTemplate( inputTemplate, new LavaRenderParameters { ExceptionHandlingStrategy = ExceptionHandlingStrategySpecifier.RenderToOutput } );

            Assert.That.Contains( result.Error?.Messages().JoinStrings( "//" ), "Parameter type 'Guid' is not supported" );
        }

        public static class TestLavaLibraryFilter
        {
            public static string AppendString( object input, string input1 )
            {
                return input.ToString() + input1.ToString();
            }
            public static string AppendGuid( object input, Guid input1 )
            {
                return input.ToString() + input1.ToString();
            }
        }

        #endregion

        #region ZebraPhoto

        [TestMethod]
        public void ZebraPhoto_WithParameters_ReturnsEncodedImageInfo()
        {
            var values = AddPersonTedDeckerToMergeDictionary();

            var options = new LavaTestRenderOptions { MergeFields = values };

            var template = "^FD{{ CurrentPerson | ZebraPhoto:'397',1.0,1.0,'LOGO',90 }}^FS";
            var outputExpected = @"
^FD^FS~DYR:LOGO,P,P,15516,,89504E470D0A1A0A0000000D494844520000018D0000018D0103000000D769BF92000000017352474200AECE1CE90000000467414D410000B18F0BFC610500000006504C5445000000FFFFFFA5D99FDD000000097048597300000EC300000EC301C76FA86400003C1F4944415478DA957C0D7C5AE5D9F7818738C2AC129AF8319F4D82A4126CD5565BA7FB22482AA11F120AC186A668D73A1B4A78D412BA3072684C5C12A74B6852B59D338D494DA004FB012808C739755AAD1F6D81CA11CEF66C6E1A84B3A9E4C49CE770DEFB403EBAFABEEFEF7D697F4980739DFFF57D5F37DCD705D1FFBF8F5948D71AF0EAF4BAFF1F121CCBA23485FF5FAEA1481A8912D81289BF03B1B5E2E1FFFDB5048E219D341D26C1336491A490684D638199D253982CD0089CA6ED0512C3617079912A42D34494A4A3C43C89C741E4C3B40FBC4DD27081C6709AA4711AA3299A5C824B831FC4224A2AB1DD978BC598275811BCC434F31710B040CFBF4244680C9E27698FF85306189EBFC5FC6FAAF48B00449D24096852176B0C8D631D743E8633F7454AF0244389E080CD020E88108A0E83D7101A9F2731DBAD0937669ABF059083A2618CC6090A40316CE14801DC0747902514C4E731C3FE288D1518061896F045852244812CCA04C427496A81643A5908BB7399D2538C2A894331F72F941821999B31B6C6164882364F9C0EB714EF3DEF0324F31BC101F39D3862676E82C33486CC6303258728871B0F962E2E2CFCC0086A817784D14C815AD0222009E07A8F3E9482E771317CC1640C9718C1FC440A0463607281C4D4325798CB32280856B43F8D3828BC50B24B49E98C4BA62FB24B0A68D81BC82EFAC3223F04813016CA31778719899005EB07687FCA66609E16FDAA787F842CC9D2C9A80F888E938C744BD657E1B654B61530350F4400DEE7AD0A9E004A0A4843DB16FD72163A1A09A56CC1799D63CC7F6C41758C49999B638C59A8258D39329660CA61F7D18C5298089C7F44693B60085C672FDE27BA789B59E8DCBA64D6948997F403782F00FFC222455517AF61A40933E40B5E360B4D65FD21643B92602890920CA5078C20C5488C14DDAE2408A3B359C87AD8A29FCEE48B0A047222800D18C80D6345AA2276490A025F4049CF24B3BA1663069F77E245C760A2996408313847E1B0835EF464BFD79F44827308F30A56D428304B9A281A9E893A0059280ABAA43193A12D389DF511C5FB1659C68BD23036A58A5712401FF685C82F311636B76CA7CCA5589A4F190BA2623451B22BF32AB6C45836192413E02598001E02DE63EE5C28D9A8C0B0095200F312B6288BC5D614CCEA0BD3F3DAC58B213F2FC97C3CE4804700A79B0FCC59289F0D9B9BE7BC48498F047335CCA44C400C338A2219F116BDA5486268CEA23E1F998561AA64C8C554B2C009019320321D4B2453C16880CC638692458ACC81302F4AC1F089454A190484E76254525993B9CDD78A1BC12B052029C9988FC03046CD05A2A82B82CA012A72D1C74CA1581025E910F3E682EA8B618615D5CC781E701E82C697184B581073A75797281A04880C740B3243C90B31E0C17489DB4261C9FAA1582BEAB1D11DC192294B4995B9FDBC226C4C0EB031414394DE000B5F38159849E9710B5DB23FB01C52CA96809C00BCC27451A4856CC158BF2D80A5829415F81051609C0A66B400FE2E299928C601422DA5376097BCD96F6AF5A54BAB2559BA0A24F5E2D3A29F010E196D2DC54BD6805A02D85C18B83B5C8CAB053F21488CF14A5BF1AFA5D595C963538164CA8FCD784B2F3818A7C7004FF882B6C9628E8619979D2741F3D9A0C96435C22088719CE184242886A2B3C81420C00A25B7C01734E6D81E740452587EBA740F8428C652717D211933316E4FA7087AB15600EB4BC6EC4ED9DA113DCC38112336A3618C224ADC47308428AD6E4BA6CC4592982999CA464AFAC28AE18C154D449178317332D2C0174765C2668D7A831851CC7AC59489813888D2F34A020602D900B9D8F93187772AD69EB5B7964C81C3C03F98B02C856631EDA48161E8C5A51FA4BE04899A5084095626FA4B0FA026A414F939122CFA8C1C457395348699F580B1D6F00CC2DC0B1894A44ACA01C9AE58BCE0802F0C9B4F34259499423AD68ED0DE79841CF3032B9512A53A255D2A6D0A4BA634C4827674DA4D1A17B24214FCA28A8E06208808881E8A22E723A24832150D67A7A6103A5EAA8C0A255D62C5582EA91524678CD1E562209331DC10B3C6740E1FE3F73070720C948540A71440228A454A8411FE2259E2B9100527113AC3F8144C2FAE2F54C923ED8CF31338202717492261733C6B3119A28952087732AB9863BE32838BEE53F44B7A6915CBB4CC840DFEF44C9E49D4F8420D07F48C21085C4AFE8C144BE91214578401CFA5BD1828C98A6A4622C0B5C0C5C0EF01280E72538A62144D908B1A9B76E742E18CDDDF012040F94594CC4331AE4232FEC59469332986C745C682301026928071FF828088A3E49185055D308E095F94C75AA6B3888308E5A278D1C58BD7908C5702713B991C4EDBF062B1B61462444B603AEEB5A099628A01C9D4C648020CC498048761C6E1D002B1943066216FD060C4B7E7914E90AA117C5E3345975EC8C351C6C6A552B04492CCE2D31112B312FE927390C51081099229C7C1CD99251026EC253597340687424193DF8BB7E01801D41565B455CC9108B302524016DC0E82928C2ED92566C9DA5316BB8168A6E9857C4A16ED5EAC488ACC311507A38879123819CC0593B94204F0C4C43D304F14A4A6F9EC00CAD83481301E8A2F6D4662B6ED28091B6278889AAF8D8AC145302B1D5EF418268DFC9BC3E452F9C0546C267C5716300F978A6EA67C67120E1005B0031338A87FC899459270C6E04091961C4E2C787E71970532004E95B62454C9012E2A48A28577F77C4AD84211C67E08783099A5B8FE20A5D48491C44511C6A48BD87EDD96EB7E90B2648CF3F729EE4A281097CCAD19E7478A25416E91E4B0148ED25F3F4024A345B648668D448A99B658956085C5C2761E6916FA3A11B3B9B1E43224EF2B8A5198DFF530B90E038E03948245988BED8B28BE0292854DF0573A23B34E168AE51A8121254F29FADB45F50BA30E90617479432C12FFC444E899D5186460E6128AF15D60DA4EB04282DA7C211194508208C0493882F1083D5F5A038D152BF1CEF922B07425B9142FB9BC551773243A236D0C374CDD8F2DD6BE60BD05113A5FBC5C94944C498F3D61CE4CA336BA986209A6124F176D44975E59DA9396484C290BED3587B7477CC5BA9E2976F0F97D1C41904C86892C2DE025927830E426665279FC9CAD7837B85856E2F8A2100BA97989E4271D381D31DA8CE136A682C418272F6DDF985D8E83C8D1975000127D36E4CEE453F9B66F98D592714926FE984AA764188A281097902CD3276804A090A08A291A0DF822B378618092402EC12899F269B2D33D0D509A82F44262404A72307108C3854B400049FDF618486B362335E701B294B23F42CFBB215ECCC4978A7F759E8E4FFB5379838F2E5E0E44C10B0495623CAD58D461854B516A8C7E3BA8048D845D8F50C55A902C9698C50B41A6F8DF68ECF13C9C9D76A7F2DB73C5EA3007926AC9DA6015604AE4621AF877920DD834885AC2984751B0B812455727186F5BDC617C4BFCCBFCC68CDBEDCD1B024163B1E863F61724C5941F85343DDD435FFA98857434C584B09132E782A502B6B49216C84FF6D74055763B0E5F4AF21D773C137327FCFAE4B559BA58DFC01853637EF5F8C9CE249D3B862C65BD853D720D0CD40A4773D3AC7F3447411C82A40D5EB7E11B1D7B62BB5CBA2D2DE4451A2B597FC38C3FE39DCE8787A6AE650AF274D114C03CE138EAFEBD39E3F57D5B96EF18E84ED2E8DB53DDF8F74DB72CDC898E161E9C5CA73B7EAEB2D9867C4B63BA823BE19B9EFBF0A9A9E7E63E32321F50444072A5A9E78C9F4FB7DD4C7EFA0EFD2DF19FD0D3737388B7ECE1AD8F964D8D103859DAF5445ABFFCFDF0F0C74DBFBFE3DB8CDD485991E0F497FD571C7DAF60C536316527489FF49CFFB7567B47C0FBF017B66F39CCE620D69A8B40ABF35BEFA8EE5F732206978A50EADE8E77E30993E6FD03CF7F0B6539DE4147DED5ADE705DEC66C672C377D000A4F8CA067BED145CDDE40F6476DD4B748A6282C96D9C77D25DF109C98F8D1407CB505F802D8FE1D44B7A0CDE6837F3BFE9DD295176D46EE999A419ABAB600948D7AFD1BF02BE9E4C4C88A1835673E5508FC23F9CBEBDE9F432E45F93ED9927F453C7627B5FBE4C484BDEB173FAFD61BDFE1DD4B25EF1D365FF3627CE6CEFA6F29F94523E16B6DB8EE2DF6C1CD7A7DB7E399DF6D9E1859776A8077E33726D73FB6791BFE1E7AFE521243BE65DF6B0206E5384071E91F380E503658BE1EBA2CEAB8E6A421F0DCF8B750AE4066FEC47B6FC35BF2C466BD61C8FC39AF88E22CDF4DBD33FA8FCD01F38E66DFA52468CC14D2559CBA33227969E2A8C9E5DA09503EDF00CF3CCE5EB7E9BEE367CE62FE6F99F27A38BD5B789441B9577FDF907963DF66F7C855012777DF244A0637DF8548DEFDD9A524F9D8C3DDFDCD00A5F6D689174DAEE5EB8EEB8CD906F8DC631ACE70EBF13FED247E8A7F0BA5F3A9C6D5350025BEE93AE5D0D8DFDED9EC1E13049C2BF7D6FCB22DF5FE9D68DFE7DFD2982DB68FB7FEF4A93BFDE527FEE6AF35940B8EEBEC00E5236EF2F1BE93B7BE750CD67F4B6329D3EB23CFAEDDF096EACB4DD7F1A69D4DD9CDEEEEEF059C3727A0FB9ADAB2D73D7AFAD8B7ACBF2E2D56ED64502E77EDFCBA7BFB11F66A9DFD5333FC91C45633F9AC667C2A6CFF164AF6846BFC0906E5F8AEC3E577567F7FEBFBEE9EEFB99C5389DED3573DE86D469BDEA0BF65978D0DBCDB014ACDE64362BD5CB563C56A5D47D601EB24B6DB3F7B56E30B645FF91649E084EBA53F3228AB6B622395A79E6C0028822E672831F1C7AB777A1F3187EFA10B9790B4F489EFF9F1E9D035C74FAB6ABFBFA1FCBF5CB52D1DD99FC0BFD893F8F1438705DEE41BBE6FA1FC59A07AE68F558ABFAAAA06D7CB06348F6F9C39F1A6E0F59E43E74299C4CE5DCDFEBBBE2FBA94E4D0D8E00DFF391DBE7CED432B9E714BC76B6F5B76EF5DFE9F74987FAA6B3A76B8F7C50D8A3FBD73F52524F73748B73D50A5F8F2ED03CF8AEAEB9567155FBEFC07D5EBC3C94F7137BA770777E88854BCE11292FE83F52FFC7EDA53BE5C21DA38E0AEBAFCF0B27B7EBA7A6DDB8D87B73A02EFFE6E04BAF27C9FF812921AA1BBB2BA4AAB3956BB757045E37F3FB0F3CB57646F29073F690FBC6BEAFC39CFBDF621BEEBFA7F2751EA1A3349B7C8DDA8785CA47EEA77070F2F5B1F943CDD76DB1973207DEE93FBA174D2AD7C81C62F2639203D5A59531FD3F63F7BABF6B7ABAB95DA2F5FE16EB97FF0CC8FD0ADB5532FF637FA5FAE2BAB34FE1B8AF8CD6B7F7E5F48EADA25DABCFF5655F36DE3CBD67FF59BE7DB429FAE2308AB636F99E9814A4DC3817F23D92AD9F19B17EB14E25EEDC08AB7C6C73636AB5FB9FCD11D31DDEF339B36A26ED768FA4283A47BC5F51793741D187E547970B2616D5F8DB296B77C70DCB7FEABA79E9366AC8150D86BCD7EC73F2AEC6E54FA2E26592B6EED5EFB90C6251738971F3C35D6F63DF52BCBAC8FD2EB0E9B13BA76DF9A4D8687FA2BA4AE2D1793A892DD2655D993E2A131C98450AE1ADCE56B9B73BFDF909D39DC9A3B9CCC1E9C794D3CD62DEE872F22192BBB6B687C4E5DDEC0EB2ADB241E941ED20ED6EBEF0C1A36CDA486F7FA0F6F5DE6DACF56F7899FBE88E4DA13759A43AC9A264135972FE857BD69F674465F4E3407C8551EFB07A6BDC139855452266A6C809748463706C6AB8FB94726B5C2FDB2C6B5D7B8F6BEF9CE3DEE8CB9E9CBF6F89DBFF7B4D64C38E52F29FB5DCF2F916CAA563634352A790AA75C5CC5E6BC607EE247EB5ED63525B3F79EA94D3CBC2796668987CB04C29A1B9748064E8F1F6C50AD1917D472CB85DA06AD6B6FFCF43DE148D0100A4D0B9F3A7CF389FE06482AEEEF7DFB22B7ACFA9E6468B85EAD74424EA5D3C5AD79A2F6D667D66F3107623A88A31E616DDCEB92D6C96B4482E717494EBB77C67E7EFF33BC519E46DAB596330E50DEFC8F5772A8D93252C167F307EDFB6B1443BD4EE5F88D8B2495EA3EF66FAE148D550AB9CE2AF9A440DC5F2B91DCA30B242FB82016C4E1409DCA419140EA52BEB348B2E3098D7FB57A6B8573BF5C3AC25D5FB7553BC466BF1C36076F84F0AF279CD0D3EFF8C5CA0967B940605C20E913D72AD78F75C905DC2A5959E3C0A9C76FB8A1B1E19E38DAFA3F573EF35D4830CABD43D55025978E29C66B1648D66C6DBA61A2413B248326A413EE5BBE7BDFF98D1074D7AA40AAB7D9F6F58C13FACEE7FEA1914A27AB42A55FA8C714A3CEF704AEF26A48CAEEBEBBEC35ED8BDF65E96AEA6752EEFFF29FF67081E29F6F7BA04A249D50F07B6F992779B67C6DC5CE068DB6D239241D6AFE8947FB6593137A6E55D0F6426B444BFCD979E523B1A9D106197B50BE65CB3C8928A07AB0EFA0D8E9145437D61E795DE75B3651ABDD71CE7C41816DF1940BC4726FB851DBCD9BE054898F16399B85B4B2895E8DF0B41492F5F6BFB5FDA753DAB9FF7042CBA271CBBBEEDCDE993DD0324353AE5FA3964F2A1BB8456B823C36BC7CCDB8AED25953255A7BE7913F58333AAD7458531FFEB0CCBCF5DD6BCFF60902D9AD0F4FF448E4A2EE5D456B8274A11AABBFA6FF8818922937263A7FFA448BBBDF2959156E437E8FFEE2F6A3ABA06567C281A704FC327E6F05172D69AC614035F182B852D63F293A20D9FF5747505B5D5527688ADDAF0B7C92D97A7674CB6D3AD3C3636303DD72B7EECA12894B3AB45EAB1AED86D85A71A2F33FE30F79869CBC7A6F387D9DF9A4F6E84AD9E5B9683ADDD0C0AEAD64B1D50B794C34E11A54F26BB6F5A2BB7BFEE14D686535BAF22D6D47D625DB3C0D67FB963F1BF38F075C12997042ED9E674CD0B07CA7585407553FC03
BD8F1DCA377B95D905033E5FFC41CFCF8D4C11AE14A9BC964DFBD4BCEEB618F9795BE7F71295D3B79FDBD5C517FFF4CF6CC23EF7DAA13F6BBC6B72647E2C9174DB5DB1407DC81F454A0B772442DE16A9874360BED3A20EE6B54AB9DDC2A7179E8C407B71D723B85E5ECA3BE6D91F16D43AE23FC9B1366FF39B34DC62B93CBFBD61695CC156FD04ED4882AE4235B887ACB0FDFFFC5797EBD4CD2623D628033644DF3C8B52B5153149DF0CB06B8439A7BE06235AE1AA865F7F6CAF8EBC756D2C93FADFEA49ACDE7694651CD4C4CC75175973D48065266BF5E55BB4A532D7E062926A541D5EB5A5135A7E79AEBD0E19A3BF1DBDE968DCAFAAE5F37EE7587E68EFC527DDDD89900DA36771C8238DDFD7717492A156B571E01B94272B7DCDF5A88DFFE8500520C0BEFCF361AE05F0CF3BABA761AC3E6003ABCF1ACAE512A1CDA505CC55C5D8D9502A9923DF493B654FD6466503C342153FDB6E9B1C2E9E4438A6DEAE7FD0FA2663F4C72D91CA74E14C401C978ADB6BF41E164694DF2D8C9907EDB83A759ACCAA1355E9D2EE23F357844686D4D01C662DAB10997D4A9D8F815201128CA770EB8AAC52C4E24BC69D7B1179EA99A7037D4D63777E12653035BC556253C8031B74FC3E6EEAF91BEC0A0342CD7F0E4DC5E48DA7C77D3DCA1473FA99E63A9C5EB79F91B43F17840F9AC32F2EA0C6A0EC2F949C598B6D7297894592C94E20F876BD8159CF18847B7F3C91B6435ADFD5D933ADE93E6C8DA06D68EEA0D266F006D8D356BF82CB6483AEE61181B6FA891C9249CC6EFADFF95FBE38EF32FA4F78B255775518284693A20BFDC1988A3E640CAEDFBA25E2BE9D5A9D6328CF15DAA2AA953D635FECABB1FB387A59759A5EAAE865AE16F437E7D03F75F2273245064AC7104A038F9268631957850E2ACE05436AF0F9C186E8D2D4B7ED4537BF075ACCAF2FEC4A9FDBCF203267391B129EE84B6BBB6DEC53036D820954B1515B5E3118342EA17FE077C54CDA995086F3A1BD6AB443A591BC31816F27D34CA764A5CAE558C29C52EC5801392C90D773FF871FDE96D07E3EA1E4DD3D9D415C8AECFFC905B7438DC8E9ADD892FA34A75559D78E3BF9878E9170FD6485D655563AFA68407FD23B51D3E35F7C91A91A135AD57F6A87B1ECCA1EDA8B5CDF7C0204BC66BA8B802064B52B54ACC8720BECC70F79AD3AB545A63CCC9AA7FE442C3AAD8F1DE13FC2BF8CFE9A6525398BF392D1657A95DE28F18C6B4FCBE7A9D503E7CB490ADDCE21F59DBB64A2BB8523474D87EAF6D13FB9F8F99106BD0EE46B3273EEC757695355CC130D607140E7120E9D61E8D7C4A25F0F9CF768DBC9492AE8B9FEA7DA96119279E07FAB25A0D660E24124FB88E03C6C4A281EA0AB56CA8FB688757A23BF5D955E44609E75E61DD26AFE90E15A4B96995C78C21982F706852DA3B2850AC4740413254C39397F1595BB6C6CE768536B0564DB9EA1AF8E9A175C9F89FFDA2634E747BB035D6FAB139AF86589CBAD5CF0194813A957A6882AD11DF78CBED3A7368DFD5E4B12181EF88A425587BA5B2BCF6AAA36432D81A6C4755FDF592C6CA6E1140910E0DF40B2119F4C427174E43C38A3FACDA56C11E916D977B5A89FF0A749FAD76E8CC2924990A44AAF96CA7BC761340A9978AC43D8D5C9E58F4E2C0B0FD97A79AFEEA9694DD32D2FB13FFE5BF56422B1FF7F882AD19B3C7DC7A9E252BAB90BB00CA806C582EE108471A5A9A777E77EC2D88DEA6AB53AA8D5A53DB570F7D5975B6B6692E156C028CF9AB15556A45EF2A23107F58C9DD2F64735CFDD977C48657FE66FE97B0B2E2CA975857C536FE9AE35CB93EEBED48516914A05440ECC12A797016AA10DDA091D64115B55601FFEEFC7A27EAF6CAE4EA7BCF3BDC61C9DC77CF565CA74F64F4D64012AB80E4BDBC9163D82CB45339C471721B14EB7994BBFFA96F26E1FF910D57BEF892D063DB9980A095AA99B9A980D7630E9EF89B56221CE52D0728FD83758DD211A85C121329D6FEF2D7B2D86EB75079F999A7B71D3BCCCDD7CEF6787DD696B914DA6ABE96C56273C61440964669E5284884A27A696AE0B13F751C40CEAAD9D586350ACFB9BD2FF2D96C81C18A66F4B6B654F2BF15E2865AF9010F7018859BA395417DDF7BF344CDCA1FBFC98EFBFB27FAD7E69E6E9FF25CF346F9EC7820998B4692E1407088EF7476716BF4B390665036B15F20123D70D7C6AEBB33E17BCCCA11365FB57AE7E187CFBF2811D5F0509F3F36E33D8FB6B63A7902902633B3508FA88A259641DCFE374F4A9EABDAB88C7E813350777DAE7F8FF726A5ACEFC39A40DE68F1D8E040EAA31A61B7A05A9C9885EED38E4ACBA141B9F8AE8DF5A239FF65EEF3A3D5E2479E5507935F5F3D26AAE699B7E75F6949C6CC9E955CAEB07B68039065B4AF41A6D642FC67DF3CD1ABFFF51E03ED5176F3EF6D9FA85DFB8492DF735A8766A61284790A6DFF974CDE5F5B5B710FA8934595BC2E48D123BA6BA3E6D8BE6796E915427E57E88C7CFBE9BD6B653C212FE0B79B9B83F68077730D1F92CBD77B018AF6881AA859A87AD32F5E9EB05E4D4DF7CB2B74A1976B224FC88F54D7DF60C6BCA16C3A66465F1A2893940F0D1E7E19DAD8A7EA1142E5E5355295FCCCCADE4D96613557EED1290E6FD93BCC59EFFC01DA1A4F04AD48B83DC596B15DB5BC1B67A1414DA5BA5E29D3A874C7B9579D7BE46A54CAAAAEF9D5F4CB2B8EF549F8E5A2BA29C2DE99447566EF0E75A54CFCC69116E0C9E22365DC6A0EE7B87BE3D9C91F4FACEA8CC9D8E59EE7EAAF3568EAEBD6F45E6F6FF1C6CC537368FB27DDFBA5E5152AC0D85A954ADDC885062FAB3ACE6A3AA7EE88712BC75E6CDA11FACEA96313DD1C683416204C84DD17F09E94482097BBE2C67DD06B43433D6C599778F7F466ED9DDE533EB715E2DE974D292636340A04D2AEEF4F659AB1E6006A40F7EC678B6B14A380B1AAEA6AB5B692CFEEAAF2436F69D4D63C24ABFE8EA135FC9D578F2AEAB492A3644BB6C3976D9F099CD3CA9CBD835AF73EA8B54925723AA13E89FBA1C93BB37FC6EECB97A95281E126FEDDCA416E3974DDDA99606C2E9CF19A5F852A0535A2F2AA59A87B626848AAEE156DD13DCD6E1254FA67207EE51A3339F9C7574F8AAB3565EB7003588FDBB6A3E8169D50D6AB380F4C795B59759D8CC3E2764B1FD24E66FF62D9362D3BF26EDC6BE4DEAD5072C4C20D496F5B1841F3ED812F4658DCEA5A91611FF446EB6971995AC6AAD5C5FB9A0403A96FF89C2BD6BDD2F4E56BAF1E3A52A72E5F1724FDD956BF216536B0B5D53CD93307818F0D5635A8D95C8DC6532B9EC477DB9B5EAF587DC692DD74EA3F1EA8ACEC76995BA7307D0A9F0AA3A72621A7BAFF8655606721BD7F4034C0E2F46893834DFCD7E2DF489C9B433143F8FE9587EAD8B7720EA762D394AD391F0FBCAB16F1D8155A741FC8A94F8A7ACB84D59A9BFCAA49FCF8AAF332CEF17B4281D8B315BB26D45DD5EDC18E6093378F99CDAF76F70A27C626D7819CECD16885139C7E715C55D654A1B04D0E565F11B1A0A6765E3FBB4CADF24EE3A930B9DD1F465BD5C2FD207D9C01E2AB25BDFD9053D6571B514F3E38E27D44013D3C7D36F0C9DB4E6BA31AAA8C475ADA72539ED6742036CEAE144ED6DC01C43F7AAE5A28E05709123BC6357D0D1D3D03DD4F5D8D983D088B3D56263FF223BD27EC4729CC6A0EF17BEBCAA1FB52FBA01DD75EAEE28DB1A1F11F3EA71A5FF75AE2335975E3DC346A6DFDACAA5C25D467A70B59633B58FD02B1D3D51C85F431E92C343C767C48CD9229947F6A656DFBC370E4C010748B2E12F0E820E54805ABB70931E9F3A9F094CFEC1676F3F9CE6DBA7D9074CB7A51572FB762F90F87CF1FB94586EEACAE523F6F317F92FB92A31AE3DD11D6A50ABEF61CDA813A54A0B4D55583F545FD9B67DED18AF6430A7D6B6DD340F9BA7332C8F7C85C32387C8C25E442EF98499B2E8FFA1DB1C0EB0372671974C5EE7DD08B8FECAA1429C5551513C38AC91A9979CCCD127CA00FEEB637CA782307D6C5A792B8A10D8B2366470D5730203DD2044A054EFFE8C07E485673756B9F462340B7422AF35D85ECEFE353D07E8873266CB7F8F1B0D53C8D9EFD50AEE43A2F8FBC0C0D6774CAB2CAD132DE9ED89A63E3ACA1C71A2157CC93CC4F920310E7BBB799BD01B23D8B868301338FCB12D56F3101F12B5D6B27849050F698F44D8DEA1EFB4688B3C9D0193418C53BF94EF5FBF1446A2A15ECC45BCC678FF0BB9D7C4E7C161A9ADCF93A4B3E01096E8E5D736C90136F740BD7046254601A7342A22B57871D369BAD23D69C417FA294F32BE40756BD0C55AF7FA2D2CD95F57006A5FFD822BE21F238C45A7606F1982393FB7AA15B717322954AE1783E1AF86F9744AE908893B3D0E6676FDF2D1BE5F1D52B74D71C53B17FA11DE9D6FC48D78E6E687F9DC5FFF5A1A0C3660A3687A632E6E724FBCB59ECBB6D2F43FC1DEF74D7560E40AC06F7A79A919E4F2679FCB2BF4F7B0333DE5721E8C7D6643C45998904E9471F799D2B94A8FB363D04A99EBC6AB74656AD1057EABEE75595DFA69241D2E78CA8B9056D1476DDEDB3846D7A72FB9C6F7BE04CE528A7AB4C60BF008DAF79E86037AF9B051D01284397BDE7E2F7953F7222801EDDD506F1A3B1109E249BF2BE66C27C62041A85466AE32F43ECFA03F76B466AF9021E40D931786223D82E7E60DE7D2C95BED0CDAE0F2542F8146DB4125ED4AC1AE24AABE43F791B7A47BAF2A9BE4AA7CC5927CD6BFA2E6B05BB9F9A3B0F271E3DB9F6285417B274642384CE9FF67604CE0E4032A7B32AF3327442FBD1C33BEBA4DDE57C1DCFBBB76FE877CE6ADEDFDB7F3CD536ED1071F4B15434D34263263261F6CA75BC8ADA06FD4390E2B19B1F2F17F3F9503D37AFE95A6F62553A59DF7FE7AFB18F9F7B03AA708782A628A1B352535E543D04F139ECAB7217A0596DDD0FCFF6D5578BF937FCC0FBABFD436E1957F5DF77FCE0AEA38FDEC9675B2D2DE94C8AC6F48642C0271C901F51D6E92E407AE9AB7F146B84DDB2EEDE0734FB25F75776D5955DFFC5BFDE6C79FF0DA8E7A918618F0675D6C28CC7FC4F559984C33E18FE2134C1BA7B6583A49F0FF135CF7B3BBB9E14F2B9823F2FBF223ABDFA87DD15D6A8379EC9D2982ED5927CCAA986CAD5B5672E40F4F9A1B327BAD47DD21E96B0795022D4D5097B8C5FFCABAEEAFDD7A0CB3C26BB657B5867A58333C1871BA1D191B2F5277F083602B5350A1D1BB8BFF8F94FDBFEC0E9E5B079230CCA1A2EABBC29E68B90398062F6ED3926E6710523E51DB350FE73CD7D877AB5FD03EC01E10F062B85A2017E8DF1D8BFEA80A90656783B9399A670CC4AA256F42399AC9AC36BFAEBCB5074A8E6856ACD11217B42FEC45FDAFECC7EBB5AD13FD27899D6C985205647C21AA5720866B1A2E69BFB044E500819F741998EFEFF4CD654F671595CF1F5C72BF9FC6EA8C678F4574E36C4915FF16B2F664A84F3D624D696FC500DA95882E5D3B310FC66C50365CF8C8AEA94A2F29DAACFA1D75955AAB1FBF6431010AFDAD1114E47DA7C9863DA1FF4B3C11640711424D8383276709F48D93BC0EE1D79C25F595E3921AB32BCA0E60ECA20FE15A77D33F9044A59131172CF1B13908BC3AD3A3A0B393E93373CB6492062F1856C9DEA33A78CC51B3DA5E5B0C4951C76DD1DB1553E477B0273E8379FBB932D81244736386621029975AD1CA8518ED5F17ACBD75E5656AB68D4D5F7C99A542323CE2BB2F602954845DA13392A7A16D4135DBCAB40EC6F9FEE5EF9D14D6F574195B21A8D6A42C6A96073DD5A68F2D426885B7170CAE301292695B57A768F817A94EBDCE09F8532B0BD4E7A5E3022D95FC517FB75EC3A48FB55E5911B9B1AF82AD96633DA5E88A7B2B628D69E688614E522E970DB2C84C4E28261F678B95C22AFDFA0E882F82ACFE57F51702747EBF92C166A0D7BC23663CAE44F858E1CE10B95D04D28B07EE7E76F28CD4A4D2F9B3F31F6AC44D325E41CE749AE6ED20EC8853F583B954BE3C939622663336B2B590AB6BB095417C60CB2BA66704DB7A077BCEA5A91CBC9654FAE1F1B944C76D5737B8F64EC417BC8A7F71AB72793EEFD0A96167AC2300B4D23AD6FF7AFA8AF95B0B8F2072FACE20A2735CF36407A802282AE3898688967C9289DCD7B838D6AFE00A45B0BC447F2F4DE46E584AB5E2C9A78A646D6D5C5B96C8760E28BC9493177A4D1E19E0B07E23177D8686B7597B1E5E3D0663B90C5A843397E9D78C0A92CBBF143B7B0B67ADFB0B86E79937CBFACF28AA374228786711AF7A7FC8A11191752044169EDCB170223ECFE065E6395E6C32BF92C4E7F8FB281F33F93435281ACB1C53D1576B44574A18CBDCDCDAB60492B2E07DB04CAE8211BB48DAE310E24AEF9A7AA5B2D6C1E3D58F7826AB78CC5BF621A24E444DE449BA3F18F1B65DD0A677F33390BB9F39D532FF1DC12FE88A64F75E5089FC51BE14A0E6C0F745569398355014FC2644CBB89983730C6E7F31BABD70214A32193CF5557AD1FAFE00886FFC9DB2FAE57B9DE621F6FD82683D42B484B7B24EAB5D229D86E52F5405D1C9EEA307018AFD1B8B577624225168E49AEFCA798CD1FAEF9E1936D41E15005BB7C452C3513237D4DC158EED48850515EADF5DB9843E0A13C21BF4730281BE675BD54064D8C83F2FFEE8F1ED2552B249A5447D0636FA228CAA47B57D55B21EC6535FB98A3E679ACF925C92EB11B1AD4DEFBB28B25500D4B2EBFF9E97E2DE4ECB9E9E9AC712AEBD17BA2C8AF865810A746CA6CAC08EBCDFEC87B55431A4820AE152A40AC0EB6C6AEFBD743C25E57A520DF199C439176AA1D9DF6C8C6E41AA7220D50BC18D996B0773588FD750DF20DE146CEB36D55A2F59B8331315736D61F6BD1B54F637AAC3D787E18E243BCC1B5605B4DB67B5147BC4EF38E8C533934A4E0348858D39F7DFFB81252CBF8E5B0691AF706FD596B2AE9110ABA5C23D2E60F66A1A954DC9F30BFDC279036826DE3890157AC5025B8AD2DE8EFE375CBCFA79110D93C1D9E0A9ADB7532AEB04AE605951219B4E7BCE1079BBC6AA
74873FB26B198C79AFEDBE641A55C0C5557DDE48FE99BB2489CCC06DF7172D80A192F0476AFBED694A123FEB144DD5373794FDD89BA86E38555FCB59660E587435CD98CC944458266475B20F9D32AFE4479B9EE167A169AA383F98423F0C7F1FB061A9BFBCB0F0936B3D0F1E60BCA0D32F648D5AA54D49D68463DA8C1FC9711397B443372FE7A80124B6D8FBC687EB5F906116F4C7D543C36581853DEF16270AC525D2E4A7A4C4673762AEDA7C257F02009AFBBEA470C4AB83D1C4FA1BAF1F7B4E31BC61A3EDFD256661C6CDDF6F6F2B7CB84DDC1F6543E14B45B0BF1F8378D822E99A07FF3CF805BE63C3193BD3DD3BCBA97BBA64270D56F06E75E52B6FC75ED46A1A477B9CAEB694D2463531E9F59CE91492AFBAAB7325F0ADBA8B6683C15F5BE257A41F1C5F8E4C36DF51F0C79B69D3EF20E9B5F1741DB31876D0AB55A031135A89AC5FDEB000A9CD293196F90287CA3E27820AEE68AC1E8ED0FB47BFC3FE0FFE7115E6B00B5C6BD762B869A65E5123E4750B39B394144502D2D76474BB0706AB2D2DAB8EA5F9686E9DEC3ED4A19707656C21C487AC86CDADF864647583CA542791098928EFA0822EDF96283A55ED3D0C5965F3610786ECDCC3B27EF503CC96F0A9D33FB3ABD4D9E567F4026D0CA86A5AE3B818FB564E6BC2D56EABF107AB6FBE8CA89675FB19CD951B72AFA9E7240F007D6A6286A8D358519C65E514083105FFC77E68C226CA4094CFF471D8934F207EB57AC1FB8EBD553E896D5C36C097F05B93B8002C6306BFB0939779453AB6A580650E0FC4CC86B25390836734CD5CA2FDF6AF9F4E7D5816349A9B0E1F5F28341B3BF732A10727BF15323DC5199D8F50873AECF88E124B66D83A59DFE434DCFB4E2E8C075BF1BCD926331D91AFE0AD31ED412430D310CBDA6A10CE2BA5CE22701094D59433E6BFEAA088D163452CE8106CBCCC30D878E7E2CE2F48CF4A5C11EC464CD5AACEDC459F5E81148D9C7A0646C397C0E1FA9A549785FF787AF080F0E94F78FB6A75668851AC555BB03E668742A18713F37C16573B9356CCD324082A411071650256CC62CBE75D9FAFA5A0B617DE08CFB827B7FCDFEDA84391E3B47A65AB1AFF46747581AA7B63BC39C52C333A8F59B0F57A5280419D53C33A119007BB3B06D5CCD51A92F0B2523E14E6F6BC27AF317E2722D24DD5F7B1D737CAEA34060EBCB50E63C5ACAFD734D8F25617B60CF7BCDFDD5655D5B3705B7340D3701C6F25B944E6898A5717DCA308685A35F47DC77C04D89C4238ADF709A018AEB5CF8D3D5ECE6891564EB5496641873475D221EC415D75CCD881FC1BF7942CECEC6681ACE9ED47C5C6D496CA9FFA98EA7A828933DD994220D4DBEF6C429EC2FE2DE11B7A64FC97CD01D253A1EBFF5E5168426ED14BD715CB47140726CF4CDBFE7F99CBBBA341F7B5604B2CD9E88E5C4F36A8803B144CB1914028BFD723DDB63818DE944CB49A576F0DEC49686D073BCC98A32E52D77B4A7B2863C66F29BF72A34FBC5C71A7632282D5F4BBBF9DE18159B2169FA8B93E52B6E958C8D9A1FF927C4D9D73D90F5B61F0EF85A636D89C941482283BA9FB89EB1FE8658ADAF9D39508F4766C21BFFAE7C3F66A8779DB96A42FDEB6A8BA1FD8CD5DCEC8FC6224D6231BB5C27D06280E4D4295153AD575708B64409E3DC71EE708574CC6559F3999CB78F5375D41B9E4209CC1438FB8D8C55A7E1D6DEF433E678C3864D9F270CCCA1779226F1CD5F498F6A0DBB2E9C110C081F1F6C759CDCA50B785B6366DFE3C3CA4AA85EEE0261053D180837FF346F604ED5A334FCCDE5DAAD9EB1AE1BD79CE1F4ED633FFD6E5B9A3427FD51B4E397320872BBC6DA6040F25CEAFCB8DF88C0B025574851D38FEE1FD51A74C933B78EB0BB147B021FFB0F1EB661BAC0F8E90A811B929417511EB8E1A6A6CC74A99F88C688EECE8D4F8C8DF8D79C660F6FAD3860BEC3609EF1B692E6B45F218334759A95CC972907376ABD112445617418B1119DE4FEDBF61AB6A8CE544D8846786DE874E0E42634D8949C540D540838EEBE8F8B0742C80CA937D174012B364C8C75BEF1C4D8987FCD04B451C519F6B79C4987DB53DEA0ED14BB5B7184B3E2A6E2D159DDF629928661BC789A9E26F7FF68AFE123D5198DDBE5DCD2D176D4BE36EE35D95BBD9A0908E23536BECB90E048D830C59C828373248DD80A7BCE3F716A8DFFD6B1BA5A2DF7C5582A3E6D46FD672267C759B53AF5D853773024A178BE4015F002737A9B0470076E3AB5E16DD507AA434DAC1B9B43276B83687BDADE1AB94F0D41653C75822131677D7E3DCA9C92667A08497C8FCB746AF5DA5B87AB8513D778F56DC4A6755E533CF1E0D11E955B79FC165FF17876D86159686F608E171DD879ECDDF778EF8B5431F68D86D0C7C7E6B268C01B7A562D84209762C0583CA9D2960905CD349926EC692A8715561EBEEEC7278657A76AB8CAFB3EDD758741DF1C40EDE69971B9AE463C79CBF334BD0F72A3691C5BEA6D6A3BB7734766233B27521EA9B8717B7A3AF0B1CF1C88276A35E510B441F011B8EC338808F8FD0E8C2E3067339953D6E2C3C34DE19A8A945F296C3E597B7877F061D4EC7D353E3620578D286E2E7EFBE6355B60A293394A8EDBC9766C0EDDD5EA8D390B6EB948E13713ED898DD83AD4BE655229AFE0F326199459A8194D665B880219CE457098A610F1A161814753A33F36E0DC7078E5E41ED29D0DC4734DC3DC6ED1F85537D325C6EE303027F999033C590CCEBDBBAB75D7AFFE7C5D48A350BFBAF75CE2F0D196C366CFD6C9FB85C21EE508D3ECC93096A5831D64271E9EF123B6047DFBA1E143BF7E966DCE1ED8FF7334FA136BCB9733A823D8D4DFC5560AEE9516BFE29C8BA34D14B06118074B1345D91914C7DEF2F80989383D5EF7BAFBE4BD9381C49E49357742305EC17C2B0EAA8B7020E2C3ECBE0245A6523E189B06282E9FEC672D7A56CD7604D6B7858CE663E7343D42F61149AE7412B23997220AF91C65F1996D30199BA176B55A6F4C3A7BA6275C73C777BA5E8D99A751FB94575DC6AFACAFB8BBC8587EED8CD743DBF1244947626DB405490EF75FB8E39FEC4813ABE7FDC3E6BF863D2D81A30F6BF6F3EBBBDC0F96507C058F0176A743885787C3614F042FECB05E7D660F5FE5F474DED67EF807BA168F21F5C131AD8C5F5BF1ACBE24BE8706299C48E461DA1ACB156642F850FF43AE434E086C64BEE8FBFAF35CA63D70F2F646A8AC9EE37EB0F43DB2176B0AC36DDE4EDFB41B830D41048F64AA5CB5620E875DAF37B47F37A80BA4B26D19B77B80DF58DF57FAB6DAE6A0720994CE5046DA1F2B64A70BC4D73B6A86BA469C32DEDC512FA50A9B3D868F9BB410BBBB5FDAFE4191B154C217F652CD117DBE9986F508EC494786933B24CA0AEE8D4FB6A09A4813DA1E084E3A9DDC8A0A5D4F09653A3A972383044621B8179D9B8ED3765A597379C205B196D9674EF94CD9402AD3DA2E951E11AF70FFB2D4618764702A688EE6F5AD21B2DD87D128EE3BA9FA0ADAD92D66C7BD1B92F1B029B83DD5F7078853A7D4FEBA841243A2410B6D42281AF7617373FEB628F9C530073E2C84EE351B0AFE882E3DEDF7ECAD54D4710F788AC7E08192A7493AA5A35A3D4DA139BF116831139DDB6177EE9439F98767B6587E815B23B9F34FC82A249A8D95F328BE88D76BA3F54CEF858F9E9EF3B80B19A4AFFB67077ACBCBC4CBA21F4742C9770D3FDA2B72B2C757FF75FEDC8515A7E9B487D6B9A742736E042BD03E3A17B8E9B53D8D4261C3895D4193CDB22EF086B3B752CDDDFC9F4F950E1E6076AB295C88154A287E43A2632AFCF6F99F1DF0C9FABB371D9A4EB993D98657D6427565F2C117E65166D25894D6777A4A28CCC971B09ADD20DBA9A7EEAF806ABEFF608BDF15F885AC962B19966A8B9D28CCBE92202294671EC5AB0B3A6CEE2FB605FA5FA0FFD6AD53FDFDB97F6C3037F4563A455DB298873958CF38BF31D242E869431185C93389348D1C29FFE536EC6C355451FEF36B4E69023A5905B7A24A7A55F1DC0DA8C629944629530EA0046950113A3AC9141EFFB2EB86DB3E57EA14A2A12D1B9EAC13B238B26EB7E2F3E25935204B020E7606D361809273133481123E5BC7E7973BB48AF3DD4E81923736A4AEEC1D820452E8F055F3E21BE199543E6BCFD1141EA1A76211B8854C611D5F399FF04C5748475C2382BA32191BD2743B3DF767E78FD0E441E2439078D8ED0965DC14628911DB6922C5B1DDDE681D9371A0329944C8E38B20BE54FBDBE5F32418426019139CA341D8C39E3C09FB88600B6DE7FED18BEEAE6A68E473D972A1CC29DCDF587E6BA99F05AC6219D81129C40C6EF7DCF4346D6C8A53DE2CAD7F235FA9A1E2237C8E52B49F0B7178DD62CED13F5D3F8F82D32902D73107241308E6CED3548EEE8C51246FF738EED83C3AD2E5E40AFBAA85B54AF735D7E4E649A253443A4CBBFD6E77A4D50F635E5F380696C168ACAB398CFD5321E0568E9409B92CF672F5F83F7E364F922123B69C172EB52F4CFBED760B8CB46C27A67F5253C8374DCA44C232194736C457F034DC85D672C48683D8CD3B74BA8E9809A4E52C95CB132406BF762E41535D5C678FACB24EC0AA83C67F432C9C86CAA70B29AC154B303D7291B9CCF668228C14300741DFE2F0CDFC78B452C266F12161E5B3FCDB3E5B44A1C2B415992BA4525682F04598AEEF8C812452304653C62FF94E055FA16C2813ED68C83EBD704CCBA6C7FD74D617B6D9B096ED148E758441D914C5E01895B0515FFCAD86A5186443FC0AEEE8F5372D90A4E8763A5E20F1708422C904D8A9E59040219347619BA340C083BDDA6AAE50B85FE1BAB6905820B1E7B10493EF705C8FF91C043243E35818293658A0D84C4EB49FC3E671C4DCDABB915B164810A3839AA309221AA6DA297A7BC6E8E9A04045D30E1883292CFF0E4F39291B6035CAD7FD79A95D8E24305F2192260B389ED0914CFF4BA23393C268C058D0118DDEBA1CAA64A9BA86FE802D76D974E2C676DA83DB739970047033150458284250618C06CC139FFFFD98A64ECB5F6BBAF9778BC7E740E06373348C21488E6809B693249668E99C43F43860AC2D8ED1915AC56168FCB5F3833F5F24491108E54B2567E60A746A860AA7F13C100C94809D410705D8C47285C784BB94B75F6B596A9703116503FF305F26C4B8992D8AB480BD560664043A8159F00E32F93BF4D06D1B561C5AEADF47C83C860241E9281E3444BC4C275FD60E18A3B30918A6ECA00EBE69C55B9F9CFAD8B2D43194B520141C4E11A1623312A84C220504B7908500E2A0F2413A5128A466F3B73D70D9E1A54E2EB04AD866703A8D7B42BE703A6C0D910612C172389D2712582105525450EFF6A67FD9B9843287C530AC10B403BB14703B8E81C8699B9B4342590C83ED1682F691E4345178E94F1FD18B24F80C4D39C214BE9DA44D11206D369A2571A0B620EC48E11412A32C08920CD37759961803D1112472B883F079982E4204C920582402E207E46A2448313DCF2918DF7DE6932594029101956518484D4F65F2B6E90C6C6F270887C38AA5A373C001F4481A442AF6A3DB9648122924EBC8D351DA9423A34079CC7007A64F0CB35B483C0B924D06ECD182F85B1F2C9138E81990FCA6C80C1D2EE0392C154CB5C7ACB1748CCCCEE16104D4F49D742840775017F7F01AB03C662771640A2827EC9F49218CCBDAE1ED34122D90BE70069F02A98ECE049748989642471A89CE90D3E4144D1BE93C45B4B460043195CDE06D059C6970216D09E4A2692791193F1A049783008ED259031533EA530431938A90C1CE3016064AA1433EAA73B18993B18B9169C5A0712B4265A68305108A943D9582A3B9284DE01D398F9B76E394317B31637632D18EC791089DF7C1086DA3B2410C87E1184164B22D0EA6A17C9A0E000B45B34BA6240A145892A70902063B85140630DBC30102B618E1304D4410B305416924725163DA2C94F6E1113244632D284252B63C61308355204552600520D284959E23DAB2248D99DC0B9D001720FB5C88B030FDED851C622C300D52A8254B63C16038D162C7E800462D76B42E8ACF7C02619923480B499024690CA03089043B4BD7503EB013A448C44622C4922C8178C6875116CC422205DAC8346F65D333A02EC7B38E306EA17082D4335DDC40CC45129A8E928001AA80E1862C45E1A819EC2EB3980F6C1B6920B503B1D06DF442437F49169B9540F04ED2C28C4F4170664C0DE0022E36EF314B6EB1C78C9126872C4ED5C0B0961C45602462A723B403E42384C671C24662A81DCE819731D24C203462596CE8FA0C62BAB098E67B124BD1CC095447361565FAC46018636630147BAD1924B2343A8341698F588D9D141E2D3656E291F96101E1D2040BA025A08A6249898497C467BA6A7198004B79B19B1CE46FB2D85E4651208E5341B8A45D825A985F7101C23A6728A4384A850A93E01D12644EB0F78F80AD2339DFF65660A6B7604B0996CA203E9C28367C83CCC88445B4B0D45284D361245C72156C717C810DE928305DDA4C4B3805A48599AE78109838F0D7D4BCDC0CD88265A897A1421E2709244D46416606D782FB13365062E60AC5E60292111AA3171B478B2840C3BEF996300263BA6219D9C1CE1438499AE998CD51C5C101741A9F6F67675AFE3B0A8502013696380CC0118AA2C344B1E793607AACD374A9657E31C1D02F4344C2871200D811A40B3891A2988678D8C1F47E17F0E254A074C93EC0A94A26031A03FE84150D610F324A63466E306F06C8D2688D30606D710E04437D01D4C936B303ACCAA5F660C001420711CC0EC4B69030332C072E368FA6818A1861480CE46466E606CC30964A6378805C9CE084314D7D6023044A82453940C015662174DE7D998F3B8A8C112495031BD9005301D899F9228CF909DC31439008F36915F0313F6134D2648A69F106DE55A01010544516E02CD3FF4C825D000CCA279C19620398402E4001E0F95484F97808852910C24C8BA1BDC074B3E5E82C589330B0B0010E48A65713A813018CD1A4A3A8D042A913172
5D233248607034C0F24CC3066070C010704D5DA0C867512C09466843026723885E10845D830663C14C68C480151821419631AC7090B333E00016E53202F40F40C46C14C9B76E70C63510AA1E14E92E9FAC7B354168F20163C4781AC18C1F01470061445F641CC28178AB0E34C6C039130B04F20B020E3377071D641C95598B112300D8ABB62EA036664BAB481A011669E10706766C388E0611A78741ADC391CA4288A200CC4D41CF0A6EC0566CC97C3D802766DF3FDED204302E0C252EF66713613D35C1E6546DA7416531F13D764AA902E4D93607A4D715B982499D66C727E680E50329925C9E2049122094210C662422A7A5E8E640060ECDF7ABE9826738B25C9C8C7902094D158C82DBD0DEE1AC62FE99103687E9A9A9F77C170CB34DBCF04977C8FA029264F5FFC00692F159CDFF11507340499112891D29B243309E592B6B222385C9AF6544421B7170AD8D2C4292604312475296779A27D7E160173119381F085314C8C0B5024F56D9816503D2D9050FE306C5B9C73F67F989106568664F18F2209561A85B4000224B121854BFB7069CC0617F76F459242264BA6713B7131CCA504A02C49A1F33B3EE67914A1C9C574482CCC51BAE431579CCB32AF649053C1062CB274C7856120FF260B122829A884D25A9CED31FFA0C8D260814B1FD47C1C144922B497C6D33442FFDF1E605364A69750523446FFBF3C98ABE8D9FF05F40C539533D7C1CF0000000049454E44AE426082^FD^FS
";

            // Verify a portion of the expected output.
            TestHelper.AssertTemplateOutput( outputExpected,
                template,
                options );
        }

        #endregion

        private LavaDataDictionary AddPersonTedDeckerToMergeDictionary( LavaDataDictionary dictionary = null, string mergeKey = "CurrentPerson" )
        {
            var personDecker = TestHelper.GetTestPersonTedDecker();

            var tedDeckerGuid = TestGuids.TestPeople.TedDecker.AsGuid();

            var rockContext = new RockContext();

            var tedDeckerPerson = new PersonService( rockContext ).Queryable().First( x => x.Guid == tedDeckerGuid );

            if ( dictionary == null )
            {
                dictionary = new LavaDataDictionary();
            }

            dictionary.AddOrReplace( mergeKey, tedDeckerPerson );

            return dictionary;
        }

        #region AppendFollowing

        [TestMethod]
        public void AppendFollowing_DocumentationExample_ProducesExpectedResult()
        {
            var options = new LavaTestRenderOptions { EnabledCommands = "rockentity" };

            var template = @"
<p>Entity Command Example</p>
{%- person where:'Id != 1' limit:'3' iterator:'People' -%}
  {%- assign followedItems = People | AppendFollowing -%}
<ul>
  {%- for item in followedItems -%}
    <li>{{ item.FullName }} - {{ item.IsFollowing }}</li>
  {%- endfor -%}
</ul>
{%- endperson -%}
";
            var outputExpected = @"
<p>Entity Command Example</p>
<ul>
<li>Giver Anonymous - false</li>
<li>Ted Decker - false</li>
<li>Cindy Decker - false</li>
</ul>
";

            TestHelper.AssertTemplateOutput( outputExpected,
                template,
                options );
        }

        [TestMethod]
        public void AppendFollowing_WhereCurrentUserHasFollowings_ShowsCorrectFollowingStatus()
        {
            var values = AddPersonTedDeckerToMergeDictionary();

            var options = new LavaTestRenderOptions { EnabledCommands = "rockentity", MergeFields = values };

            var template = @"
{%- person where:'Guid == ""<benJonesGuid>"" || Guid == ""<billMarbleGuid>"" || Guid == ""<alishaMarbleGuid>""' iterator:'People' -%}
  {%- assign followedItems = People | AppendFollowing | Sort:'FullName' -%}
<ul>
  {%- for item in followedItems -%}
    <li>{{ item.FullName }} - {{ item.IsFollowing }}</li>
  {%- endfor -%}
</ul>
{%- endperson -%}
";

            template = template.Replace( "<benJonesGuid>", TestGuids.TestPeople.BenJones )
                .Replace( "<billMarbleGuid>", TestGuids.TestPeople.BillMarble )
                .Replace( "<alishaMarbleGuid>", TestGuids.TestPeople.AlishaMarble );

            var expectedOutputs = new List<string>()
            {
                "<li>Alisha Marble - false</li>",
                "<li>Ben Jones - true</li>",
                "<li>Bill Marble - true</li>"
            };

            TestHelper.AssertTemplateOutput( expectedOutputs,
                template,
                options );
        }

        [TestMethod]
        public void AppendFollowing_ForPersistedDataset_ShowsCorrectFollowingStatus()
        {
            var template = @"
{% assign followedItems = 'persons' | PersistedDataset | AppendFollowing | Sort:'FullName' %}
<ul>
  {%- for item in followedItems -%}
    <li>{{ item.FullName }} - {{ item.IsFollowing }}</li>
  {%- endfor -%}
</ul>

";

            var outputExpected = @"
<ul><li>Alisha Marble - false</li><li>Ben Jones - true</li><li>Bill Marble - true</li></ul>
";
            var values = AddPersonTedDeckerToMergeDictionary();

            var options = new LavaTestRenderOptions { EnabledCommands = "rockentity", MergeFields = values };

            TestHelper.AssertTemplateOutput( outputExpected,
                template,
                options );
        }

        #endregion

        #region FilterFollowed

        [TestMethod]
        public void FilterFollowed_ForEntityCollectionWithFollowedAndUnfollowed_ReturnsOnlyFollowed()
        {
            var values = AddPersonTedDeckerToMergeDictionary();

            var options = new LavaTestRenderOptions { EnabledCommands = "rockentity", MergeFields = values };

            var template = @"
{%- person where:'Guid == ""<benJonesGuid>"" || Guid == ""<billMarbleGuid>"" || Guid == ""<alishaMarbleGuid>""' iterator:'People' -%}
  {%- assign followedItems = People | AppendFollowing | FilterFollowed | Sort:'FullName' -%}
<ul>
  {%- for item in followedItems -%}
    <li>{{ item.FullName }} - {{ item.IsFollowing }}</li>
  {%- endfor -%}
</ul>
{%- endperson -%}
";
            template = template.Replace( "<benJonesGuid>", TestGuids.TestPeople.BenJones )
                .Replace( "<billMarbleGuid>", TestGuids.TestPeople.BillMarble )
                .Replace( "<alishaMarbleGuid>", TestGuids.TestPeople.AlishaMarble );

            // Alisha Marble should be excluded because she is not followed by Ted.
            var expectedOutputs = new List<string>()
            {
                "<li>Ben Jones - true</li>",
                "<li>Bill Marble - true</li>"
            };

            TestHelper.AssertTemplateOutput( expectedOutputs,
                template,
                options );
        }

        #endregion

        #region FromCache

        /// <summary>
        /// Verify the documentation example for this filter.
        /// </summary>
        [TestMethod]
        public void FromCache_DocumentationExample_ReturnsExpectedOutput()
        {
            var template = @"
<h4>Current Person's Campus</h4>
{% assign campus = CurrentPerson.PrimaryCampusId | FromCache:'Campus' %}
Current Person's Campus Is: {{ campus.Name }}
{% assign allCampuses = 'All' | FromCache:'Campus' %}
<h4>All Campuses</h4>
<ul>
{% for c in allCampuses %}
    <li>{{ c.Name }} </li>
{% endfor %}
</ul>
";

            var expectedOutput = @"
<h4>Current Person's Campus</h4>
Current Person's Campus Is: Main Campus
<h4>All Campuses</h4>
<ul>
    <li>Stepping Stone</li>
    <li>Main Campus</li>
</ul>
";

            // Set CurrentPerson to Ted Decker.
            var mergeFields = AddPersonTedDeckerToMergeDictionary();

            TestHelper.AssertTemplateOutput( expectedOutput, template, new LavaTestRenderOptions { MergeFields = mergeFields } );
        }

        #endregion

        #region RunLavaFilter

        /// <summary>
        /// Verify the documentation example for this filter.
        /// </summary>
        [TestMethod]
        public void RunLavaFilter_DocumentationExample_ReturnsExpectedOutput()
        {
            var template = @"
{% capture lava %}{% raw %}{% assign test = 'hello' %}{{ test }}{% endraw %}{% endcapture %}
{{ lava | RunLava }}
";

            TestHelper.AssertTemplateOutput( "hello", template );
        }

        #endregion
    }
}
