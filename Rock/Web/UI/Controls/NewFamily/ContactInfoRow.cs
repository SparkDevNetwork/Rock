// <copyright>
// Copyright by the Spark Development Network
//
// Licensed under the Rock Community License (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
// http://www.rockrms.com/license
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.
// </copyright>
//
using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Linq;
using System.Web;
using System.Web.UI;
using System.Web.UI.HtmlControls;
using System.Web.UI.WebControls;

using Rock;
using Rock.Model;
using Rock.Web.Cache;

namespace Rock.Web.UI.Controls
{
    /// <summary>
    /// Displays a bootstrap badge
    /// </summary>
    public class NewGroupContactInfoRow : CompositeControl
    {
        /// <summary>
        /// The Group role key
        /// </summary>
        ///
        private PhoneNumberBox _pnbHomePhone;
        private PhoneNumberBox _pnbCellPhone;
        private RockCheckBox _cbIsMessagingEnabled;
        private EmailBox _ebEmail;

        /// <summary>
        /// Gets or sets the person GUID.
        /// </summary>
        /// <value>
        /// The person GUID.
        /// </value>
        public Guid? PersonGuid
        {
            get
            {
                if ( ViewState["PersonGuid"] != null )
                {
                    return (Guid)ViewState["PersonGuid"];
                }
                else
                {
                    return Guid.Empty;
                }
            }
            set { ViewState["PersonGuid"] = value; }
        }

        /// <summary>
        /// Gets or sets the name of the person.
        /// </summary>
        /// <value>
        /// The name of the person.
        /// </value>
        public string PersonName
        {
            get { return ViewState["PersonName"] as string ?? string.Empty; }
            set { ViewState["PersonName"] = value; }
        }

        /// <summary>
        /// Gets or sets a value indicating whether [show cell phone first].
        /// </summary>
        /// <value>
        ///   <c>true</c> if [show cell phone first]; otherwise, <c>false</c>.
        /// </value>
        public bool ShowCellPhoneFirst
        {
            get
            {
                return ViewState["ShowCellPhoneFirst"] as bool? ?? false;
            }
            set
            {
                ViewState["ShowCellPhoneFirst"] = value;
            }
        }

        /// <summary>
        /// Gets or sets the home phone country code.
        /// </summary>
        /// <value>
        /// The home phone country code.
        /// </value>
        public string HomePhoneCountryCode
        {
            get
            {
                EnsureChildControls();
                return _pnbHomePhone.CountryCode;
            }
            set
            {
                EnsureChildControls();
                _pnbHomePhone.CountryCode = value;
            }
        }

        /// <summary>
        /// Gets or sets the home phone number.
        /// </summary>
        /// <value>
        /// The home phone number.
        /// </value>
        public string HomePhoneNumber
        {
            get
            {
                EnsureChildControls();
                return _pnbHomePhone.Number;
            }
            set
            {
                EnsureChildControls();
                _pnbHomePhone.Number = value;
            }
        }

        /// <summary>
        /// Gets or sets the cell phone country code.
        /// </summary>
        /// <value>
        /// The cell phone country code.
        /// </value>
        public string CellPhoneCountryCode
        {
            get
            {
                EnsureChildControls();
                return _pnbCellPhone.CountryCode;
            }
            set
            {
                _pnbCellPhone.CountryCode = value;
                EnsureChildControls();
            }
        }

        /// <summary>
        /// Gets or sets the cell phone number.
        /// </summary>
        /// <value>
        /// The cell phone number.
        /// </value>
        public string CellPhoneNumber
        {
            get
            {
                EnsureChildControls();
                return _pnbCellPhone.Number;
            }
            set
            {
                EnsureChildControls();
                _pnbCellPhone.Number = value;
            }
        }

        /// <summary>
        /// Gets or sets the email.
        /// </summary>
        /// <value>
        /// The email.
        /// </value>
        public string Email
        {
            get
            {
                EnsureChildControls();
                return _ebEmail.Text;
            }
            set
            {
                EnsureChildControls();
                _ebEmail.Text = value;
            }
        }

        /// <summary>
        /// Gets or sets a value indicating whether this instance is messaging visible.
        /// </summary>
        /// <value>
        /// <c>true</c> if this instance is messaging visible; otherwise, <c>false</c>.
        /// </value>
        public bool IsMessagingVisible
        {
            get { return ViewState["IsMessagingVisible"] as bool? ?? true; }
            set { ViewState["IsMessagingVisible"] = value; }
        }

        /// <summary>
        /// Gets or sets the Is Messaging Enabled bool.
        /// </summary>
        /// <value>
        /// True/False.
        /// </value>
        public bool IsMessagingEnabled
        {
            get
            {
                EnsureChildControls();
                return _cbIsMessagingEnabled.Checked;
            }
            set
            {
                EnsureChildControls();
                _cbIsMessagingEnabled.Checked = value;
            }
        }

        /// <summary>
        /// Gets or sets the validation group.
        /// </summary>
        /// <value>
        /// The validation group.
        /// </value>
        public string ValidationGroup
        {
            get
            {
                EnsureChildControls();
                return _pnbHomePhone.ValidationGroup;
            }
            set
            {
                EnsureChildControls();
                _pnbHomePhone.ValidationGroup = value;
                _pnbCellPhone.ValidationGroup = value;
                _cbIsMessagingEnabled.ValidationGroup = value;
                _ebEmail.ValidationGroup = value;
            }
        }

        /// <summary>
        /// Initializes a new instance of the <see cref="NewGroupContactInfoRow" /> class.
        /// </summary>
        public NewGroupContactInfoRow()
            : base()
        {
            _pnbHomePhone = new PhoneNumberBox();
            _pnbCellPhone = new PhoneNumberBox();
            _cbIsMessagingEnabled = new RockCheckBox();
            _ebEmail = new EmailBox();
        }

        /// <summary>
        /// Raises the <see cref="E:System.Web.UI.Control.Init" /> event.
        /// </summary>
        /// <param name="e">An <see cref="T:System.EventArgs" /> object that contains the event data.</param>
        protected override void OnInit( EventArgs e )
        {
            base.OnInit( e );

            string script = @"
    $('input[id$=""_pnbHomePhone""]').on('change', function(e) {
        if ($(this).val() != '') {
            var masterId = $(this).prop('id');
            var masterVal = $(this).val();
            $('input[id$=""_pnbHomePhone""]').each( function(e) {
                if ($(this).prop('id') != masterId && $(this).val() == '') {
                    $(this).val(masterVal);
                    phoneNumberBoxFormatNumber($(this));
                }
            });
        }
    });
";
            ScriptManager.RegisterStartupScript( this, this.GetType(), "home-phone", script, true );

        }
        /// <summary>
        /// Called by the ASP.NET page framework to notify server controls that use composition-based implementation to create any child controls they contain in preparation for posting back or rendering.
        /// </summary>
        protected override void CreateChildControls()
        {
            base.CreateChildControls();
            Controls.Clear();

            _pnbHomePhone.ID = "_pnbHomePhone";
            _pnbCellPhone.ID = "_pnbCellPhone";
            _cbIsMessagingEnabled.ID = "_cbIsMessagingEnabled";
            _ebEmail.ID = "_ebEmail";


            Controls.Add( _pnbHomePhone );
            Controls.Add( _pnbCellPhone );
            Controls.Add(_cbIsMessagingEnabled);
            Controls.Add(_ebEmail);

            var homePhone = DefinedValueCache.Get( Rock.SystemGuid.DefinedValue.PERSON_PHONE_TYPE_HOME );
            _pnbHomePhone.Placeholder = homePhone != null ? homePhone.Value.EndsWith("Phone") ? homePhone.Value : homePhone.Value + " Phone" : "Home Phone";
            _pnbHomePhone.Required = false;
            _pnbHomePhone.Attributes.Add( "autocomplete", "off" );

            var cellPhone = DefinedValueCache.Get( Rock.SystemGuid.DefinedValue.PERSON_PHONE_TYPE_MOBILE );
            _pnbCellPhone.Placeholder = cellPhone != null ? cellPhone.Value.EndsWith( "Phone" ) ? cellPhone.Value : cellPhone.Value + " Phone" : "Cell Phone";
            _pnbCellPhone.Required = false;
            _pnbCellPhone.Attributes.Add( "autocomplete", "off" );

            _ebEmail.Placeholder = "Email";
            _ebEmail.Required = false;
        }

        /// <summary>
        /// Outputs server control content to a provided <see cref="T:System.Web.UI.HtmlTextWriter" /> object and stores tracing information about the control if tracing is enabled.
        /// </summary>
        /// <param name="writer">The <see cref="T:System.Web.UI.HtmlTextWriter" /> object that receives the control content.</param>
        public override void RenderControl( HtmlTextWriter writer )
        {
            if ( this.Visible )
            {
                writer.AddAttribute( "rowid", ID );
                writer.RenderBeginTag( HtmlTextWriterTag.Tr );

                writer.AddAttribute( "class", "person-name" );
                writer.RenderBeginTag( HtmlTextWriterTag.Td );

                writer.Write( PersonName );
                writer.RenderEndTag();

                if ( ShowCellPhoneFirst )
                {
                    RenderCellPhone( writer );
                    RenderHomePhone( writer );
                }
                else
                {
                    RenderHomePhone( writer );
                    RenderCellPhone( writer );
                }

                writer.AddAttribute( "class", "person-email" );
                writer.RenderBeginTag( HtmlTextWriterTag.Td );
                writer.AddAttribute( "class", "form-group" );
                writer.RenderBeginTag( HtmlTextWriterTag.Div );
                _ebEmail.RenderControl( writer );
                writer.RenderEndTag();
                writer.RenderEndTag();

                writer.RenderEndTag();  // Tr
            }
        }

        private void RenderHomePhone( HtmlTextWriter writer )
        {
            writer.AddAttribute( "class", "person-home-phone" );
            writer.RenderBeginTag( HtmlTextWriterTag.Td );
            writer.AddAttribute( "class", "form-group" );
            writer.RenderBeginTag( HtmlTextWriterTag.Div );
            _pnbHomePhone.RenderControl( writer );
            writer.RenderEndTag();
            writer.RenderEndTag();
        }

        private void RenderCellPhone( HtmlTextWriter writer )
        {
            writer.AddAttribute( "class", "person-cell-phone" );
            writer.RenderBeginTag( HtmlTextWriterTag.Td );
            writer.AddAttribute( "class", "form-group" );
            writer.RenderBeginTag( HtmlTextWriterTag.Div );
            _pnbCellPhone.RenderControl( writer );
            writer.RenderEndTag();
            writer.RenderEndTag();

            if ( IsMessagingVisible )
            {
                writer.AddAttribute( "class", "person-sms" );
                writer.RenderBeginTag( HtmlTextWriterTag.Td );
                writer.AddAttribute( "class", "text-center" );
                writer.RenderBeginTag( HtmlTextWriterTag.Div );
                _cbIsMessagingEnabled.RenderControl( writer );
                writer.RenderEndTag();
                writer.RenderEndTag();
            }
        }
    }

}