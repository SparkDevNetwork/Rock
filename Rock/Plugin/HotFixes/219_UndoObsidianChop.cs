// <copyright>
// Copyright by the Spark Development Network
//
// Licensed under the Rock Community License (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
// http://www.rockrms.com/license
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.
// </copyright>

using System.Collections.Generic;

namespace Rock.Plugin.HotFixes
{
    /// <summary>
    /// Plug-in migration
    /// </summary>
    /// <seealso cref="Rock.Plugin.Migration" />
    [MigrationNumber( 219, "1.17.0" )]
    public class UndoObsidianChop : Migration
    {
        /// <summary>
        /// Up methods
        /// </summary>
        public override void Up()
        {
            //----------------------------------------------------------------------------------
            // <auto-generated>
            //     This Up() migration method was generated by the Rock.CodeGeneration project.
            //     The purpose is to prevent hotfix migrations from running when they are not
            //     needed. The migrations in this file are run by an EF migration instead.
            // </auto-generated>
            //----------------------------------------------------------------------------------
        }

        private void OldUp()
        {
            SwapBlockUp();
        }

        /// <summary>
        /// 
        /// </summary>
        public override void Down()
        {
        }

        private void SwapBlockUp()
        {
            RegisterBlockAttributesForSwap();
            SwapObsidianBlocks();
        }

        private void RegisterBlockAttributesForSwap()
        {
            RockMigrationHelper.UpdateBlockType( "Defined Type Detail", "Displays the details of the given defined type.", "~/Blocks/Core/DefinedTypeDetail.ascx", "Core", "08C35F15-9AF7-468F-9D50-CDFD3D21220C" );

            RockMigrationHelper.UpdateBlockType( "Defined Value List", "Block for viewing values for a defined type.", "~/Blocks/Core/DefinedValueList.ascx", "Core", "0AB2D5E9-9272-47D5-90E4-4AA838D2D3EE" );

            /*
	            11/15/2024 - JC & KH
	            Update the qualifier value to match the new webforms BlockTypeId.
	            This could happen if the church updates regularly and the webforms 
	            block was chopped and then re-added as part of this migration.
	            RockMigrationHelper.AddOrUpdateBlockTypeAttribute method expects
	            the EntityTypeQualifierValue to match the current BlockTypeId.
	            We can't just delete the attribute though because upgrading 
	            from an older (< 16.0) could cause data loss.
 
	            Reason: Premature chop of some blocks prevents use of non-obsidian FieldTypes.
            */
            Sql( @"UPDATE a SET
	EntityTypeQualifierValue = CONVERT(NVARCHAR(400), bt.Id)
FROM (
	SELECT '0305EF98-C791-4626-9996-F189B9BB674C' WebformsAttributeGuid, '08C35F15-9AF7-468F-9D50-CDFD3D21220C' WebformsBlockTypeGuid
	UNION SELECT '9280D61F-C4F3-4A3E-A9BB-BCD67FF78637', '0AB2D5E9-9272-47D5-90E4-4AA838D2D3EE' -- Does this need names (i.e WebformsAttributeGuid, WebformsBlockTypeGuid)
	UNION SELECT '87DAF7ED-AAF5-4D5C-8339-CB30B16CC9FF', '0AB2D5E9-9272-47D5-90E4-4AA838D2D3EE'
	UNION SELECT '0A3F078E-8A2A-4E9D-9763-3758E123E042', '0AB2D5E9-9272-47D5-90E4-4AA838D2D3EE'
	UNION SELECT '80765648-83B0-4B75-A296-851384C41CAB', '0AB2D5E9-9272-47D5-90E4-4AA838D2D3EE'
	UNION SELECT 'DF5BE156-A4B8-4FA5-A730-0579733F42F5', '0AB2D5E9-9272-47D5-90E4-4AA838D2D3EE'
) attributes
JOIN [dbo].[Attribute] a ON a.[Guid] = WebformsAttributeGuid
LEFT JOIN [dbo].[BlockType] bt ON bt.[Guid] = WebformsBlockTypeGuid
WHERE a.EntityTypeQualifierValue <> CONVERT(NVARCHAR(400), bt.Id)" );

            // Attribute for BlockType
            //   BlockType: Defined Type Detail
            //   Category: Core
            //   Attribute: DefinedType
            RockMigrationHelper.AddOrUpdateBlockTypeAttribute( "08C35F15-9AF7-468F-9D50-CDFD3D21220C", "BC48720C-3610-4BCF-AE66-D255A17F1CDF", "Defined Type", "DefinedType", "Defined Type", @"If a Defined Type is set, only details for it will be displayed (regardless of the querystring parameters).", 0, @"", "0305EF98-C791-4626-9996-F189B9BB674C" );

            // Attribute for BlockType
            //   BlockType: Defined Value List
            //   Category: Core
            //   Attribute: Defined Type
            RockMigrationHelper.AddOrUpdateBlockTypeAttribute( "0AB2D5E9-9272-47D5-90E4-4AA838D2D3EE", "BC48720C-3610-4BCF-AE66-D255A17F1CDF", "Defined Type", "DefinedType", "", @"If a Defined Type is set, only its Defined Values will be displayed (regardless of the querystring parameters).", 0, @"", "9280D61F-C4F3-4A3E-A9BB-BCD67FF78637" );

            // Attribute for BlockType
            //   BlockType: Defined Value List
            //   Category: Core
            //   Attribute: core.CustomGridColumnsConfig
            RockMigrationHelper.AddOrUpdateBlockTypeAttribute( "0AB2D5E9-9272-47D5-90E4-4AA838D2D3EE", "9C204CD0-1233-41C5-818A-C5DA439445AA", "core.CustomGridColumnsConfig", "core.CustomGridColumnsConfig", "", @"", 0, @"", "87DAF7ED-AAF5-4D5C-8339-CB30B16CC9FF" );

            // Attribute for BlockType
            //   BlockType: Defined Value List
            //   Category: Core
            //   Attribute: core.CustomActionsConfigs
            RockMigrationHelper.AddOrUpdateBlockTypeAttribute( "0AB2D5E9-9272-47D5-90E4-4AA838D2D3EE", "9C204CD0-1233-41C5-818A-C5DA439445AA", "core.CustomActionsConfigs", "core.CustomActionsConfigs", "core.CustomActionsConfigs", @"", 0, @"", "0A3F078E-8A2A-4E9D-9763-3758E123E042" );

            // Attribute for BlockType
            //   BlockType: Defined Value List
            //   Category: Core
            //   Attribute: core.EnableDefaultWorkflowLauncher
            RockMigrationHelper.AddOrUpdateBlockTypeAttribute( "0AB2D5E9-9272-47D5-90E4-4AA838D2D3EE", "1EDAFDED-DFE6-4334-B019-6EECBA89E05A", "core.EnableDefaultWorkflowLauncher", "core.EnableDefaultWorkflowLauncher", "core.EnableDefaultWorkflowLauncher", @"", 0, @"True", "80765648-83B0-4B75-A296-851384C41CAB" );

            // Attribute for BlockType
            //   BlockType: Defined Value List
            //   Category: Core
            //   Attribute: core.CustomGridEnableStickyHeaders
            RockMigrationHelper.AddOrUpdateBlockTypeAttribute( "0AB2D5E9-9272-47D5-90E4-4AA838D2D3EE", "1EDAFDED-DFE6-4334-B019-6EECBA89E05A", "core.CustomGridEnableStickyHeaders", "core.CustomGridEnableStickyHeaders", "core.CustomGridEnableStickyHeaders", @"", 0, @"False", "DF5BE156-A4B8-4FA5-A730-0579733F42F5" );
        }

        private void SwapObsidianBlocks()
        {
            // Custom swap to replace Obsidian DefinedTypeDetail with Webforms DefinedTypeDetail.
            RockMigrationHelper.ReplaceWebformsWithObsidianBlockMigration(
                "Swap Webforms Blocks",
                blockTypeReplacements: new Dictionary<string, string> {
                { "f431f950-f007-493e-81c8-16559fe4c0f0", "0AB2D5E9-9272-47D5-90E4-4AA838D2D3EE" }, // DefinedValueList -> DefinedValueList.ascx
                { "73fd23b4-fa3a-49ea-b271-ffb228c6a49e", "08C35F15-9AF7-468F-9D50-CDFD3D21220C" }, // DefinedTypeDetail -> DefinedTypeDetail.ascx
                },
                migrationStrategy: "Swap",
                jobGuid: SystemGuid.ServiceJob.DATA_MIGRATIONS_170_SWAP_WEBFORMS_BLOCKS,
                blockAttributeKeysToIgnore: null );
        }

    }
}
