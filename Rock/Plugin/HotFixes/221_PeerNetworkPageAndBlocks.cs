// <copyright>
// Copyright by the Spark Development Network
//
// Licensed under the Rock Community License (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
// http://www.rockrms.com/license
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.
// </copyright>

using System;

using Rock.Model;

namespace Rock.Plugin.HotFixes
{
    /// <summary>
    /// Plug-in migration
    /// </summary>
    /// <seealso cref="Rock.Plugin.Migration" />
    [MigrationNumber( 221, "1.17.0" )]
    public class PeerNetworkPageAndBlocks : Migration
    {
        /// <summary>
        /// Up methods
        /// </summary>
        public override void Up()
        {
            //----------------------------------------------------------------------------------
            // <auto-generated>
            //     This Up() migration method was generated by the Rock.CodeGeneration project.
            //     The purpose is to prevent hotfix migrations from running when they are not
            //     needed. The migrations in this file are run by an EF migration instead.
            // </auto-generated>
            //----------------------------------------------------------------------------------
        }

        private void OldUp()
        {
            AddPeerNetworkPageAndBlocksUp();
        }

        /// <summary>
        /// 
        /// </summary>
        public override void Down()
        {
            AddPeerNetworkPageAndBlocksDown();
        }

        /// <summary>
        /// JPH: Add Peer Network page and blocks - up.
        /// </summary>
        private void AddPeerNetworkPageAndBlocksUp()
        {
            #region Cleanup Spark Site Feature-Development Blocks And Page

            // Delete the following blocks and page that were added to the Spark site for the development of this
            // feature. This way, we'll ensure the final blocks and page are seeded the same across all Rock instances.

            // Person Profile > SectionA2 > Peer Network block.
            RockMigrationHelper.DeleteBlock( "1CD1D0BF-7377-4244-896F-56AA80A2CAEB" );

            // Peer Network > SectionC1 > Peer List block.
            RockMigrationHelper.DeleteBlock( "64961379-E7EC-456E-9A44-493C5F2DB7D9" );

            // Peer Network > SectionC1 > Peer Map block.
            RockMigrationHelper.DeleteBlock( "9552A5AD-8B5A-470C-9136-58FE49F394CC" );

            // The [HtmlContent] records will cascade-delete.
            // The blocks' orphaned [AttributeValue] records will be deleted by the RockCleanup job.

            // Person Pages > Peer Network page.
            RockMigrationHelper.DeletePage( "0A93F551-1226-473E-A8EF-F1DC6680FA39" );

            // The [PageRoute] record will cascade-delete.

            #endregion Cleanup Spark Site Feature-Development Blocks And Page

            #region Add Person Profile > Peer Network Page

            // Add Page 
            //  Internal Name: Peer Network
            //  Site: Rock RMS
            RockMigrationHelper.AddPage( true, "BF04BB7E-BE3A-4A38-A37C-386B55496303", "6AD84AFC-B3A1-4E30-B53B-C6E57B513839", "Peer Network", "", "AC27E363-108F-4876-8177-2DC9A65815B7", "" );

            // Add Page Route
            //   Page:Peer Network
            //   Route:person/{PersonId}/peer-graph
            RockMigrationHelper.AddOrUpdatePageRoute( "AC27E363-108F-4876-8177-2DC9A65815B7", "person/{PersonId}/peer-graph", "D4A5A34D-4968-4F6A-B516-FC301842B809" );

            // Hide the page from navigation.
            Sql( @"
UPDATE [Page]
SET [DisplayInNavWhen] = 2
WHERE [Guid] = 'AC27E363-108F-4876-8177-2DC9A65815B7';" );

            #endregion Add Person Profile > Peer Network Page

            #region Add Peer Network > Peer Map Block

            // Add Block 
            //  Block Name: Peer Map
            //  Page Name: Peer Network
            //  Layout: -
            //  Site: Rock RMS
            RockMigrationHelper.AddBlock( true, "AC27E363-108F-4876-8177-2DC9A65815B7".AsGuid(), null, "C2D29296-6A87-47A9-A753-EE4E9159C4C4".AsGuid(), "19B61D65-37E3-459F-A44F-DEF0089118A3".AsGuid(), "Peer Map", "SectionC1", @"", @"", 0, "D2D0FF94-1816-4B43-A49D-104CC42A5DC3" );

            // Add/Update HtmlContent for Block: Peer Map
            RockMigrationHelper.UpdateHtmlContentBlock( "D2D0FF94-1816-4B43-A49D-104CC42A5DC3", @"/-
    IMPORTANT
    Do not change this Lava template as it will be updated in future releases as we
    continue to innovate on this feature. These updates will wipe out your changes.
-/

{% assign personId = 'Global' | PageParameter:'PersonId' %}

{% sql %}

    SELECT 
        tp.[NickName] + ' ' + tp.[LastName] AS [TargetName]
        , tp.[Id] AS [TargetPersonId]
        , pn.[RelationshipScore]
        , pn.[RelationshipTrend]
        , pn.[RelationshipTypeValueId]
        , pn.[RelatedEntityId]
        , pn.[Caption]
    FROM [PeerNetwork] pn
        INNER JOIN [Person] tp ON tp.[Id] = pn.[TargetPersonId]
    WHERE [SourcePersonId] = {{ personId }};

{% endsql %}

<div class=""card card-profile card-peer-map panel-widget"">

    <div class=""card-header"">
        <span class=""card-title"">Peer Map</span>
    </div>

    <div class=""card-section p-0"">
        <div style=""height: 800px"">
            {[ networkgraph height:'100%' minimumnodesize:'10' highlightcolor:'#bababa' ]}

                {% assign followingConnectionsValueId = '84E0360E-0828-E5A5-4BCC-F3113BE338A1' | GuidToId:'DefinedValue' %}
                {% assign following = results | Where:'RelationshipTypeValueId', followingConnectionsValueId %}

                [[ node id:'F-MASTER' label:'Following' color:'#36cf8c' ]][[ endnode ]]

                {% for followed in following %}
                    [[ node id:'F-{{ followed.TargetPersonId }}' label:'{{ followed.TargetName }}' color:'#88ebc0' size:'10' ]][[ endnode ]]
                    [[ edge source:'F-MASTER' target:'F-{{ followed.TargetPersonId }}' color:'#c4c4c4' ]][[ endedge ]]
                {% endfor %}

                {% assign groupConnectionsValueId = 'CB51DC46-FBDB-43DA-B7F3-60E7C6E70F40' | GuidToId:'DefinedValue' %}
                {% assign groups = results | Where:'RelationshipTypeValueId', groupConnectionsValueId | GroupBy:'RelatedEntityId' %}

                {% for group in groups %}
                    {% assign parts = group | PropertyToKeyValue %}

                    {% assign groupName = parts.Value | First | Property:'Caption' %}
                    [[ node id:'G-{{ parts.Key }}' label:""{{ groupName }}"" color:'#4e9fd9' ]][[ endnode ]]

                    {% for member in parts.Value %}
                        [[ node id:'GM-{{ parts.Key }}-{{ member.TargetPersonId }}' label:'{{ member.TargetName }}' color:'#a6d5f7' ]][[ endnode ]]

                        [[ edge source:'GM-{{ parts.Key }}-{{ member.TargetPersonId }}' target:'G-{{ parts.Key }}' color:'#c4c4c4' ]][[ endedge ]]
                    {% endfor %}

                {% endfor %}

            {[ endnetworkgraph ]}
        </div>
    </div>
</div>", "A311EB92-5BB5-407D-AF6C-74BC9FB9FA64" );

            // Add Block Attribute Value
            //   Block: Peer Map
            //   BlockType: HTML Content
            //   Category: CMS
            //   Block Location: Page=Peer Network, Site=Rock RMS
            //   Attribute: Start in Code Editor mode
            /*   Attribute Value: True */
            RockMigrationHelper.AddBlockAttributeValue( "D2D0FF94-1816-4B43-A49D-104CC42A5DC3", "0673E015-F8DD-4A52-B380-C758011331B2", @"True" );

            // Add Block Attribute Value
            //   Block: Peer Map
            //   BlockType: HTML Content
            //   Category: CMS
            //   Block Location: Page=Peer Network, Site=Rock RMS
            //   Attribute: Image Root Folder
            /*   Attribute Value: ~/Content */
            RockMigrationHelper.AddBlockAttributeValue( "D2D0FF94-1816-4B43-A49D-104CC42A5DC3", "26F3AFC6-C05B-44A4-8593-AFE1D9969B0E", @"~/Content" );

            // Add Block Attribute Value
            //   Block: Peer Map
            //   BlockType: HTML Content
            //   Category: CMS
            //   Block Location: Page=Peer Network, Site=Rock RMS
            //   Attribute: Is Secondary Block
            /*   Attribute Value: False */
            RockMigrationHelper.AddBlockAttributeValue( "D2D0FF94-1816-4B43-A49D-104CC42A5DC3", "04C15DC1-DFB6-4D63-A7BC-0507D0E33EF4", @"False" );

            // Add Block Attribute Value
            //   Block: Peer Map
            //   BlockType: HTML Content
            //   Category: CMS
            //   Block Location: Page=Peer Network, Site=Rock RMS
            //   Attribute: User Specific Folders
            /*   Attribute Value: False */
            RockMigrationHelper.AddBlockAttributeValue( "D2D0FF94-1816-4B43-A49D-104CC42A5DC3", "9D3E4ED9-1BEF-4547-B6B0-CE29FE3835EE", @"False" );

            // Add Block Attribute Value
            //   Block: Peer Map
            //   BlockType: HTML Content
            //   Category: CMS
            //   Block Location: Page=Peer Network, Site=Rock RMS
            //   Attribute: Validate Markup
            /*   Attribute Value: True */
            RockMigrationHelper.AddBlockAttributeValue( "D2D0FF94-1816-4B43-A49D-104CC42A5DC3", "6E71FE26-5628-4DDA-BDBC-8E4D47BE72CD", @"True" );

            // Add Block Attribute Value
            //   Block: Peer Map
            //   BlockType: HTML Content
            //   Category: CMS
            //   Block Location: Page=Peer Network, Site=Rock RMS
            //   Attribute: Enabled Lava Commands
            /*   Attribute Value: Sql */
            RockMigrationHelper.AddBlockAttributeValue( "D2D0FF94-1816-4B43-A49D-104CC42A5DC3", "7146AC24-9250-4FC4-9DF2-9803B9A84299", @"Sql" );

            // Add Block Attribute Value
            //   Block: Peer Map
            //   BlockType: HTML Content
            //   Category: CMS
            //   Block Location: Page=Peer Network, Site=Rock RMS
            //   Attribute: Document Root Folder
            /*   Attribute Value: ~/Content */
            RockMigrationHelper.AddBlockAttributeValue( "D2D0FF94-1816-4B43-A49D-104CC42A5DC3", "3BDB8AED-32C5-4879-B1CB-8FC7C8336534", @"~/Content" );

            // Add Block Attribute Value
            //   Block: Peer Map
            //   BlockType: HTML Content
            //   Category: CMS
            //   Block Location: Page=Peer Network, Site=Rock RMS
            //   Attribute: Require Approval
            /*   Attribute Value: False */
            RockMigrationHelper.AddBlockAttributeValue( "D2D0FF94-1816-4B43-A49D-104CC42A5DC3", "EC2B701B-4C1D-4F3F-9C77-A73C75D7FF7A", @"False" );

            // Add Block Attribute Value
            //   Block: Peer Map
            //   BlockType: HTML Content
            //   Category: CMS
            //   Block Location: Page=Peer Network, Site=Rock RMS
            //   Attribute: Cache Duration
            /*   Attribute Value: 0 */
            RockMigrationHelper.AddBlockAttributeValue( "D2D0FF94-1816-4B43-A49D-104CC42A5DC3", "4DFDB295-6D0F-40A1-BEF9-7B70C56F66C4", @"0" );

            // Add Block Attribute Value
            //   Block: Peer Map
            //   BlockType: HTML Content
            //   Category: CMS
            //   Block Location: Page=Peer Network, Site=Rock RMS
            //   Attribute: Enable Versioning
            /*   Attribute Value: False */
            RockMigrationHelper.AddBlockAttributeValue( "D2D0FF94-1816-4B43-A49D-104CC42A5DC3", "7C1CE199-86CF-4EAE-8AB3-848416A72C58", @"False" );

            #endregion Add Peer Network > Peer Map Block

            #region Add Peer Network > Peer List Block

            // Add Block 
            //  Block Name: Peer List
            //  Page Name: Peer Network
            //  Layout: -
            //  Site: Rock RMS
            RockMigrationHelper.AddBlock( true, "AC27E363-108F-4876-8177-2DC9A65815B7".AsGuid(), null, "C2D29296-6A87-47A9-A753-EE4E9159C4C4".AsGuid(), "19B61D65-37E3-459F-A44F-DEF0089118A3".AsGuid(), "Peer List", "SectionC1", @"", @"", 1, "46775056-3ADF-43CD-809A-88EE3378C039" );

            // Add/Update HtmlContent for Block: Peer List
            RockMigrationHelper.UpdateHtmlContentBlock( "46775056-3ADF-43CD-809A-88EE3378C039", @"/-
    IMPORTANT
    Do not change this Lava template as it will be updated in future releases as we
    continue to innovate on this feature. These updates will wipe out your changes.
-/

{% assign personId = 'Global' | PageParameter:'PersonId' %}

{% sql %}

    SELECT
        tp.[NickName] + ' ' + tp.[LastName] AS [TargetName]
        , tp.[Id] AS [TargetPersonId]
        , CAST( ROUND( SUM(pn.[RelationshipScore]), 0 ) AS INT ) AS [RelationshipScore]
        , MAX(pn.[RelationshipTrend]) AS [RelationshipTrend]
        , SUM( pn.[RelationshipScore] ) - SUM( pn.[RelationshipScoreLastUpdateValue] ) AS [PointDifference]
    FROM [PeerNetwork] pn
        INNER JOIN [Person] tp ON tp.[Id] = pn.[TargetPersonId]
    WHERE [SourcePersonId] = {{ personId }}
    GROUP BY tp.[NickName], tp.[LastName], tp.[Id]
    ORDER BY [RelationshipScore] DESC;

{% endsql %}

<div class=""card card-profile card-peer-network panel-widget"">

    <div class=""card-header"">
        <span class=""card-title"">Full Peer Network</span>
    </div>

    <div class=""card-section"">
        <div class=""row"">
            {% for peer in results %}
                <div class=""col-xs-8"">
                    <a href=""/person/{{ peer.TargetPersonId }}"">
                        {{ peer.TargetName }}
                    </a>
                </div>
                <div class=""col-xs-2"">{{ peer.RelationshipScore }}</div>
                <div class=""col-xs-2"">
                    {% if peer.PointDifference > 0 %}
                        <i class=""fa fa-arrow-up text-success""></i>
                    {% elseif peer.PointDifference < 0 %}
                        <i class=""fa fa-arrow-down text-danger""></i>
                    {% else %}
                        <i class=""fa fa-minus text-muted""></i>
                    {% endif %}
                </div>
            {% endfor %}
        </div>
    </div>
</div>", "0A35B353-E14E-4B9C-8E0C-7E7D0863A67B" );

            // Add Block Attribute Value
            //   Block: Peer List
            //   BlockType: HTML Content
            //   Category: CMS
            //   Block Location: Page=Peer Network, Site=Rock RMS
            //   Attribute: Enable Versioning
            /*   Attribute Value: False */
            RockMigrationHelper.AddBlockAttributeValue( "46775056-3ADF-43CD-809A-88EE3378C039", "7C1CE199-86CF-4EAE-8AB3-848416A72C58", @"False" );

            // Add Block Attribute Value
            //   Block: Peer List
            //   BlockType: HTML Content
            //   Category: CMS
            //   Block Location: Page=Peer Network, Site=Rock RMS
            //   Attribute: Cache Duration
            /*   Attribute Value: 0 */
            RockMigrationHelper.AddBlockAttributeValue( "46775056-3ADF-43CD-809A-88EE3378C039", "4DFDB295-6D0F-40A1-BEF9-7B70C56F66C4", @"0" );

            // Add Block Attribute Value
            //   Block: Peer List
            //   BlockType: HTML Content
            //   Category: CMS
            //   Block Location: Page=Peer Network, Site=Rock RMS
            //   Attribute: Require Approval
            /*   Attribute Value: False */
            RockMigrationHelper.AddBlockAttributeValue( "46775056-3ADF-43CD-809A-88EE3378C039", "EC2B701B-4C1D-4F3F-9C77-A73C75D7FF7A", @"False" );

            // Add Block Attribute Value
            //   Block: Peer List
            //   BlockType: HTML Content
            //   Category: CMS
            //   Block Location: Page=Peer Network, Site=Rock RMS
            //   Attribute: Start in Code Editor mode
            /*   Attribute Value: True */
            RockMigrationHelper.AddBlockAttributeValue( "46775056-3ADF-43CD-809A-88EE3378C039", "0673E015-F8DD-4A52-B380-C758011331B2", @"True" );

            // Add Block Attribute Value
            //   Block: Peer List
            //   BlockType: HTML Content
            //   Category: CMS
            //   Block Location: Page=Peer Network, Site=Rock RMS
            //   Attribute: Document Root Folder
            /*   Attribute Value: ~/Content */
            RockMigrationHelper.AddBlockAttributeValue( "46775056-3ADF-43CD-809A-88EE3378C039", "3BDB8AED-32C5-4879-B1CB-8FC7C8336534", @"~/Content" );

            // Add Block Attribute Value
            //   Block: Peer List
            //   BlockType: HTML Content
            //   Category: CMS
            //   Block Location: Page=Peer Network, Site=Rock RMS
            //   Attribute: Enabled Lava Commands
            /*   Attribute Value: Sql */
            RockMigrationHelper.AddBlockAttributeValue( "46775056-3ADF-43CD-809A-88EE3378C039", "7146AC24-9250-4FC4-9DF2-9803B9A84299", @"Sql" );

            // Add Block Attribute Value
            //   Block: Peer List
            //   BlockType: HTML Content
            //   Category: CMS
            //   Block Location: Page=Peer Network, Site=Rock RMS
            //   Attribute: Is Secondary Block
            /*   Attribute Value: False */
            RockMigrationHelper.AddBlockAttributeValue( "46775056-3ADF-43CD-809A-88EE3378C039", "04C15DC1-DFB6-4D63-A7BC-0507D0E33EF4", @"False" );

            // Add Block Attribute Value
            //   Block: Peer List
            //   BlockType: HTML Content
            //   Category: CMS
            //   Block Location: Page=Peer Network, Site=Rock RMS
            //   Attribute: Image Root Folder
            /*   Attribute Value: ~/Content */
            RockMigrationHelper.AddBlockAttributeValue( "46775056-3ADF-43CD-809A-88EE3378C039", "26F3AFC6-C05B-44A4-8593-AFE1D9969B0E", @"~/Content" );

            // Add Block Attribute Value
            //   Block: Peer List
            //   BlockType: HTML Content
            //   Category: CMS
            //   Block Location: Page=Peer Network, Site=Rock RMS
            //   Attribute: User Specific Folders
            /*   Attribute Value: False */
            RockMigrationHelper.AddBlockAttributeValue( "46775056-3ADF-43CD-809A-88EE3378C039", "9D3E4ED9-1BEF-4547-B6B0-CE29FE3835EE", @"False" );

            // Add Block Attribute Value
            //   Block: Peer List
            //   BlockType: HTML Content
            //   Category: CMS
            //   Block Location: Page=Peer Network, Site=Rock RMS
            //   Attribute: Validate Markup
            /*   Attribute Value: True */
            RockMigrationHelper.AddBlockAttributeValue( "46775056-3ADF-43CD-809A-88EE3378C039", "6E71FE26-5628-4DDA-BDBC-8E4D47BE72CD", @"True" );

            #endregion Add Peer Network > Peer List Block

            #region Add Person Profile > Peer Network Block

            // Get the order of the existing "Implied Relationship" block we're about to delete (so we can add a new
            // block in its place).
            var blockOrder = SqlScalar( "SELECT [Order] FROM [Block] WHERE [Guid] = '32847AAF-15F5-4F8B-9F84-92D6AE827857';" ) as int?;
            if ( !blockOrder.HasValue )
            {
                // The block didn't exist. Get the max order of blocks in the target page/zone.
                blockOrder = SqlScalar( $@"
DECLARE @PageId INT = (SELECT TOP 1 [Id] FROM [Page] WHERE [Guid] = '08DBD8A5-2C35-4146-B4A8-0F7652348B25');
SELECT MAX([Order]) FROM [Block] WHERE [PageId] = @PageId AND [Zone] = 'SectionA2';" ) as int?;

                if ( blockOrder.HasValue )
                {
                    // Increment by one to add the new "Peer Network" block after all existing blocks.
                    blockOrder++;
                }
                else
                {
                    // There are no blocks in this zone; add the "Peer Network" block as the first and only block.
                    blockOrder = 0;
                }
            }

            // Delete the Person Profile > SectionA2 > Implied Relationship block.
            // The block's orphaned [AttributeValue] records will be deleted by the RockCleanup job.
            RockMigrationHelper.DeleteBlock( "32847AAF-15F5-4F8B-9F84-92D6AE827857" );

            // Add Block 
            //  Block Name: Peer Network
            //  Page Name: Person Profile
            //  Layout: -
            //  Site: Rock RMS
            RockMigrationHelper.AddBlock( true, "08DBD8A5-2C35-4146-B4A8-0F7652348B25".AsGuid(), null, "C2D29296-6A87-47A9-A753-EE4E9159C4C4".AsGuid(), "19B61D65-37E3-459F-A44F-DEF0089118A3".AsGuid(), "Peer Network", "SectionA2", @"", @"", blockOrder.Value, "6094C135-10E2-4AF4-A46B-1FC6D073A854" );

            // Add/Update HtmlContent for Block: Peer Network
            RockMigrationHelper.UpdateHtmlContentBlock( "6094C135-10E2-4AF4-A46B-1FC6D073A854", @"/-
    IMPORTANT
    Do not change this Lava template as it will be updated in future releases as we
    continue to innovate on this feature. These updates will wipe out your changes.
-/

{% assign personId = 'Global' | PageParameter:'PersonId' %}

{% sql %}

    SELECT
        TOP 20
        tp.[NickName] + ' ' + tp.[LastName] AS [TargetName]
        , tp.[Id] AS [TargetPersonId]
        , CAST( ROUND( SUM(pn.[RelationshipScore]), 0 ) AS INT ) AS [RelationshipScore]
        , MAX(pn.[RelationshipTrend]) AS [RelationshipTrend]
        , SUM( pn.[RelationshipScore] ) - SUM( pn.[RelationshipScoreLastUpdateValue] ) AS [PointDifference]
    FROM [PeerNetwork] pn
        INNER JOIN [Person] tp ON tp.[Id] = pn.[TargetPersonId]
    WHERE [SourcePersonId] = {{ personId }}
    GROUP BY tp.[NickName], tp.[LastName], tp.[Id]
    ORDER BY [RelationshipScore] DESC;

{% endsql %}

<div class=""card card-profile card-peer-network panel-widget"">

    <div class=""card-header"">
        <span class=""card-title"">Peer Network</span>

        <div class=""panel-labels"">
            <a href=""/person/{{ personId }}/peer-graph""><span class=""label label-default"">Peer Graph</span></a>
        </div>
    </div>

    <div class=""card-section"">
        <div class=""row"">
            {% for peer in results %}
                <div class=""col-xs-8"">
                    <a href=""/person/{{ peer.TargetPersonId }}"">
                        {{ peer.TargetName }}
                    </a>
                </div>
                <div class=""col-xs-2"">{{ peer.RelationshipScore }}</div>
                <div class=""col-xs-2"">
                    {% if peer.PointDifference > 0 %}
                        <i class=""fa fa-arrow-up text-success""></i>
                    {% elseif peer.PointDifference < 0 %}
                        <i class=""fa fa-arrow-down text-danger""></i>
                    {% else %}
                        <i class=""fa fa-minus text-muted""></i>
                    {% endif %}
                </div>
            {% endfor %}
        </div>
    </div>
</div>", "879C5623-3A45-4D6F-9759-F9A294D7425B" );

            // Add Block Attribute Value
            //   Block: Peer Network
            //   BlockType: HTML Content
            //   Category: CMS
            //   Block Location: Page=Person Profile, Site=Rock RMS
            //   Attribute: Validate Markup
            /*   Attribute Value: True */
            RockMigrationHelper.AddBlockAttributeValue( "6094C135-10E2-4AF4-A46B-1FC6D073A854", "6E71FE26-5628-4DDA-BDBC-8E4D47BE72CD", @"True" );

            // Add Block Attribute Value
            //   Block: Peer Network
            //   BlockType: HTML Content
            //   Category: CMS
            //   Block Location: Page=Person Profile, Site=Rock RMS
            //   Attribute: Cache Duration
            /*   Attribute Value: 0 */
            RockMigrationHelper.AddBlockAttributeValue( "6094C135-10E2-4AF4-A46B-1FC6D073A854", "4DFDB295-6D0F-40A1-BEF9-7B70C56F66C4", @"0" );

            // Add Block Attribute Value
            //   Block: Peer Network
            //   BlockType: HTML Content
            //   Category: CMS
            //   Block Location: Page=Person Profile, Site=Rock RMS
            //   Attribute: Enable Versioning
            /*   Attribute Value: False */
            RockMigrationHelper.AddBlockAttributeValue( "6094C135-10E2-4AF4-A46B-1FC6D073A854", "7C1CE199-86CF-4EAE-8AB3-848416A72C58", @"False" );

            // Add Block Attribute Value
            //   Block: Peer Network
            //   BlockType: HTML Content
            //   Category: CMS
            //   Block Location: Page=Person Profile, Site=Rock RMS
            //   Attribute: Require Approval
            /*   Attribute Value: False */
            RockMigrationHelper.AddBlockAttributeValue( "6094C135-10E2-4AF4-A46B-1FC6D073A854", "EC2B701B-4C1D-4F3F-9C77-A73C75D7FF7A", @"False" );

            // Add Block Attribute Value
            //   Block: Peer Network
            //   BlockType: HTML Content
            //   Category: CMS
            //   Block Location: Page=Person Profile, Site=Rock RMS
            //   Attribute: Start in Code Editor mode
            /*   Attribute Value: True */
            RockMigrationHelper.AddBlockAttributeValue( "6094C135-10E2-4AF4-A46B-1FC6D073A854", "0673E015-F8DD-4A52-B380-C758011331B2", @"True" );

            // Add Block Attribute Value
            //   Block: Peer Network
            //   BlockType: HTML Content
            //   Category: CMS
            //   Block Location: Page=Person Profile, Site=Rock RMS
            //   Attribute: Enabled Lava Commands
            /*   Attribute Value: Sql */
            RockMigrationHelper.AddBlockAttributeValue( "6094C135-10E2-4AF4-A46B-1FC6D073A854", "7146AC24-9250-4FC4-9DF2-9803B9A84299", @"Sql" );

            // Add Block Attribute Value
            //   Block: Peer Network
            //   BlockType: HTML Content
            //   Category: CMS
            //   Block Location: Page=Person Profile, Site=Rock RMS
            //   Attribute: Document Root Folder
            /*   Attribute Value: ~/Content */
            RockMigrationHelper.AddBlockAttributeValue( "6094C135-10E2-4AF4-A46B-1FC6D073A854", "3BDB8AED-32C5-4879-B1CB-8FC7C8336534", @"~/Content" );

            // Add Block Attribute Value
            //   Block: Peer Network
            //   BlockType: HTML Content
            //   Category: CMS
            //   Block Location: Page=Person Profile, Site=Rock RMS
            //   Attribute: Is Secondary Block
            /*   Attribute Value: False */
            RockMigrationHelper.AddBlockAttributeValue( "6094C135-10E2-4AF4-A46B-1FC6D073A854", "04C15DC1-DFB6-4D63-A7BC-0507D0E33EF4", @"False" );

            // Add Block Attribute Value
            //   Block: Peer Network
            //   BlockType: HTML Content
            //   Category: CMS
            //   Block Location: Page=Person Profile, Site=Rock RMS
            //   Attribute: Image Root Folder
            /*   Attribute Value: ~/Content */
            RockMigrationHelper.AddBlockAttributeValue( "6094C135-10E2-4AF4-A46B-1FC6D073A854", "26F3AFC6-C05B-44A4-8593-AFE1D9969B0E", @"~/Content" );

            // Add Block Attribute Value
            //   Block: Peer Network
            //   BlockType: HTML Content
            //   Category: CMS
            //   Block Location: Page=Person Profile, Site=Rock RMS
            //   Attribute: User Specific Folders
            /*   Attribute Value: False */
            RockMigrationHelper.AddBlockAttributeValue( "6094C135-10E2-4AF4-A46B-1FC6D073A854", "9D3E4ED9-1BEF-4547-B6B0-CE29FE3835EE", @"False" );

            #endregion Add Person Profile > Peer Network Block

            #region Add Peer Network Stored Procedures

            // Ensure these settings are set as expected so they persist with the stored procedure.
            // But first, read their current values to restore them after the migration.
            var isAnsiNullsOn = Convert.ToBoolean( SqlScalar( "SELECT CASE WHEN SESSIONPROPERTY('ANSI_NULLS') = 1 THEN 1 ELSE 0 END;" ) );
            var isQuotedIdentifierOn = Convert.ToBoolean( SqlScalar( "SELECT CASE WHEN SESSIONPROPERTY('QUOTED_IDENTIFIER') = 1 THEN 1 ELSE 0 END;" ) );

            Sql( "SET ANSI_NULLS ON;" );
            Sql( "SET QUOTED_IDENTIFIER ON;" );

            // Add [spPeerNetwork_UpdateFollowing] (dropping it first if it already exists).
            Sql( @"
IF EXISTS (SELECT * FROM sys.objects WHERE OBJECT_ID = OBJECT_ID(N'[dbo].[spPeerNetwork_UpdateFollowing]') AND TYPE IN (N'P', N'PC'))
    DROP PROCEDURE [dbo].[spPeerNetwork_UpdateFollowing];" );

            Sql( HotFixMigrationResource._221_PeerNetworkPageAndBlocks_spPeerNetwork_UpdateFollowing );

            // Add [spPeerNetwork_UpdateGroupConnections] (dropping it first if it already exists).
            Sql( @"
IF EXISTS (SELECT * FROM sys.objects WHERE OBJECT_ID = OBJECT_ID(N'[dbo].[spPeerNetwork_UpdateGroupConnections]') AND TYPE IN (N'P', N'PC'))
    DROP PROCEDURE [dbo].[spPeerNetwork_UpdateGroupConnections];" );

            Sql( HotFixMigrationResource._221_PeerNetworkPageAndBlocks_spPeerNetwork_UpdateGroupConnections );

            // Restore the original settings.
            Sql( $"SET ANSI_NULLS {( isAnsiNullsOn ? "ON" : "OFF" )};" );
            Sql( $"SET QUOTED_IDENTIFIER {( isQuotedIdentifierOn ? "ON" : "OFF" )};" );

            #endregion Add Peer Network Stored Procedures

            #region Add Peer Network Job

            Sql( $@"
DECLARE @Now DATETIME = (SELECT GETDATE());

IF EXISTS
(
    SELECT [Id]
    FROM [ServiceJob]
    WHERE [Guid] = '{Rock.SystemGuid.ServiceJob.CALCULATE_PEER_NETWORK}'
)
BEGIN
    UPDATE [ServiceJob]
    SET [Name] = 'Calculate Peer Network'
        , [Description] = 'Job that calculates Rock''s peer networks for individuals.'
        , [Class] = 'Rock.Jobs.CalculatePeerNetwork'
        , [CronExpression] = '0 5 2 1 1/1 ? *'
        , [ModifiedDateTime] = @Now
    WHERE [Guid] = '{Rock.SystemGuid.ServiceJob.CALCULATE_PEER_NETWORK}';
END
ELSE
BEGIN
    INSERT INTO [ServiceJob]
    (
        [IsSystem]
        , [IsActive]
        , [Name]
        , [Description]
        , [Class]
        , [CronExpression]
        , [NotificationStatus]
        , [Guid]
        , [CreatedDateTime]
        , [ModifiedDateTime]
        , [HistoryCount]
    )
    VALUES
    (
        0
        , 1
        , 'Calculate Peer Network'
        , 'Job that calculates Rock''s peer networks for individuals.'
        , 'Rock.Jobs.CalculatePeerNetwork'
        , '0 5 2 1 1/1 ? *'
        , 1
        , '{Rock.SystemGuid.ServiceJob.CALCULATE_PEER_NETWORK}'
        , @Now
        , @Now
        , 500
    );
END" );

            #endregion Add Peer Network Job

            #region Add and Update Peer Network Indexes

            RockMigrationHelper.AddPostUpdateServiceJob(
                name: "Rock Update Helper v17.0 - Add and Update Peer Network Indexes",
                description: "This job will add new and update existing indexes to support the Peer Network feature.",
                jobType: "Rock.Jobs.PostV17AddAndUpdatePeerNetworkIndexes",
                cronExpression: "0 0 21 1/1 * ? *",
                guid: Rock.SystemGuid.ServiceJob.DATA_MIGRATIONS_170_ADD_AND_UPDATE_PEER_NETWORK_INDEXES );

            #endregion Add and Update Peer Network Indexes

            #region Delete Legacy Peer Network Groups and Group Type

            try
            {
                Sql( @"
DECLARE @GroupTypeId INT = (SELECT TOP 1 [Id] FROM [GroupType] WHERE [Guid] = '8C0E5852-F08F-4327-9AA5-87800A6AB53E');

-- [GroupMember] records tied to these groups will cascade-delete.
DELETE [Group] WHERE [GroupTypeId] = @GroupTypeId;" );

                RockMigrationHelper.DeleteGroupType( "8C0E5852-F08F-4327-9AA5-87800A6AB53E" );
            }
            catch ( Exception ex )
            {
                // This could be risky, as there might be unforeseen foreign key relationships to the records we're
                // trying to delete here. If there's an exception, log it and move on. It's not detrimental for these
                // records to remain in the database. But let's at least try to hide this group type from display in
                // lists and navigation, and ensure it doesn't take part in the new Peer Network functionality.
                Sql( @"
DECLARE @GroupTypeId INT = (SELECT TOP 1 [Id] FROM [GroupType] WHERE [Guid] = '8C0E5852-F08F-4327-9AA5-87800A6AB53E');

UPDATE [GroupType]
SET [ShowInGroupList] = 0
    , [ShowInNavigation] = 0
    , [ModifiedDateTime] = GETDATE()
    , [IsPeerNetworkEnabled] = 0
    , [RelationshipStrength] = 0
    , [RelationshipGrowthEnabled] = 0
    , [LeaderToLeaderRelationshipMultiplier] = 0
    , [LeaderToNonLeaderRelationshipMultiplier] = 0
    , [NonLeaderToLeaderRelationshipMultiplier] = 0
    , [NonLeaderToNonLeaderRelationshipMultiplier] = 0
WHERE [Id] = @GroupTypeId;

UPDATE [Group]
SET [IsActive] = 0
    , [ModifiedDateTime] = GETDATE()
    , [RelationshipStrengthOverride] = NULL
    , [RelationshipGrowthEnabledOverride] = NULL
    , [LeaderToLeaderRelationshipMultiplierOverride] = NULL
    , [LeaderToNonLeaderRelationshipMultiplierOverride] = NULL
    , [NonLeaderToLeaderRelationshipMultiplierOverride] = NULL
    , [NonLeaderToNonLeaderRelationshipMultiplierOverride] = NULL
WHERE [GroupTypeId] = @GroupTypeId;" );

                var exception = new Exception( "Unable to delete legacy Peer Network Groups and Group Type.", ex );
                ExceptionLogService.LogException( exception );
            }

            #endregion Delete Legacy Peer Network Groups and Group Type
        }

        /// <summary>
        /// JPH: Add Peer Network page and blocks - down.
        /// </summary>
        private void AddPeerNetworkPageAndBlocksDown()
        {
            #region Delete Peer Network Job

            Sql( $@"
DELETE FROM [ServiceJob]
WHERE [Guid] = '{Rock.SystemGuid.ServiceJob.CALCULATE_PEER_NETWORK}';" );

            #endregion Delete Peer Network Job

            #region Delete Peer Network Stored Procedures

            // Delete [spPeerNetwork_UpdateGroupConnections].
            Sql( "DROP PROCEDURE [dbo].[spPeerNetwork_UpdateGroupConnections];" );

            // Delete [spPeerNetwork_UpdateFollowing].
            Sql( "DROP PROCEDURE [dbo].[spPeerNetwork_UpdateFollowing];" );

            #endregion Delete Peer Network Stored Procedures

            #region Delete Person Profile > Peer Network Block

            // Remove Block
            //  Name: Peer Network, from Page: Person Profile, Site: Rock RMS
            //  from Page: Person Profile, Site: Rock RMS
            RockMigrationHelper.DeleteBlock( "6094C135-10E2-4AF4-A46B-1FC6D073A854" );

            // The [HtmlContent] record will cascade-delete.
            // The block's orphaned [AttributeValue] records will be deleted by the RockCleanup job.

            // Don't re-add the Person Profile > SectionA2 > Implied Relationship block, as we're not sure they would
            // have still had it + we don't know which settings they might have modified.

            #endregion Delete Person Profile > Peer Network Block

            #region Delete Peer Network > Peer List Block

            // Remove Block
            //  Name: Peer List, from Page: Peer Network, Site: Rock RMS
            //  from Page: Peer Network, Site: Rock RMS
            RockMigrationHelper.DeleteBlock( "46775056-3ADF-43CD-809A-88EE3378C039" );

            // The [HtmlContent] record will cascade-delete.
            // The block's orphaned [AttributeValue] records will be deleted by the RockCleanup job.

            #endregion Delete Peer Network > Peer List Block

            #region Delete Peer Network > Peer Map Block

            // Remove Block
            //  Name: Peer Map, from Page: Peer Network, Site: Rock RMS
            //  from Page: Peer Network, Site: Rock RMS
            RockMigrationHelper.DeleteBlock( "D2D0FF94-1816-4B43-A49D-104CC42A5DC3" );

            // The [HtmlContent] record will cascade-delete.
            // The block's orphaned [AttributeValue] records will be deleted by the RockCleanup job.

            #endregion Delete Peer Network > Peer Map Block

            #region Delete Person Profile > Peer Network Page

            // Delete Page 
            //  Internal Name: Peer Network
            //  Site: Rock RMS
            //  Layout: Person Profile Detail
            RockMigrationHelper.DeletePage( "AC27E363-108F-4876-8177-2DC9A65815B7" );

            // The [PageRoute] record will cascade-delete.

            #endregion Delete Person Profile > Peer Network Page
        }
    }
}
