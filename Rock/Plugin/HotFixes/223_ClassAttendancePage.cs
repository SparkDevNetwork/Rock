// <copyright>
// Copyright by the Spark Development Network
//
// Licensed under the Rock Community License (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
// http://www.rockrms.com/license
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.
// </copyright>

using Rock.Model;
using Rock.Security;

namespace Rock.Plugin.HotFixes
{
    /// <summary>
    /// Plug-in migration
    /// </summary>
    /// <seealso cref="Rock.Plugin.Migration" />
    [MigrationNumber( 223, "1.17.0" )]
    public class ClassAttendancePage : Migration
    {
        private const string RSR_ROCK_ADMINISTRATION_GUID = "628C51A8-4613-43ED-A18D-4A6FB999273E";
        private const string RSR_STAFF_GUID = "2C112948-FF4C-46E7-981A-0257681EADF4";
        private const string RSR_STAFF_LIKE_GUID = "300BA2C8-49A3-44BA-A82A-82E3FD8C3745";
        private const string RSR_LMS_ADMINISTRATION_GUID = "5E0E02A9-F16B-437E-A9D9-C3D9D6AFABB0";
        private const string RSR_LMS_WORKER_GUID = "B5481A0E-52E3-4D7B-93B5-A8F5C908DC67";

        /// <summary>
        /// Up methods
        /// </summary>
        public override void Up()
        {
            //----------------------------------------------------------------------------------
            // <auto-generated>
            //     This Up() migration method was generated by the Rock.CodeGeneration project.
            //     The purpose is to prevent hotfix migrations from running when they are not
            //     needed. The migrations in this file are run by an EF migration instead.
            // </auto-generated>
            //----------------------------------------------------------------------------------
        }

        private void OldUp()
        {
            AddLMSEntitySecurity();
            AddAttendancePages();
        }

        /// <summary>
        /// 
        /// </summary>
        public override void Down()
        {

        }

        private void AddLMSEntitySecurity()
        {
            // LMS Administration: View, Edit and Administrate.
            RockMigrationHelper.AddSecurityAuthForEntityType(
                typeof( LearningProgram ).FullName,
                0,
                Authorization.VIEW,
                true,
                RSR_LMS_ADMINISTRATION_GUID,
                0,
                "B878C8FE-B197-4616-A2A8-87BD3DDF1641" );

            RockMigrationHelper.AddSecurityAuthForEntityType(
                typeof( LearningProgram ).FullName,
                0,
                Authorization.EDIT,
                true,
                RSR_LMS_ADMINISTRATION_GUID,
                0,
                "2EDF461A-0D74-4E8A-844D-72997A49E210" );

            RockMigrationHelper.AddSecurityAuthForEntityType(
                typeof( LearningProgram ).FullName,
                0,
                Authorization.ADMINISTRATE,
                true,
                RSR_LMS_ADMINISTRATION_GUID,
                0,
                "1BE10CD9-8251-4B61-8DFB-1341B9B1C2D7" );

            // Rock Administration
            RockMigrationHelper.AddSecurityAuthForEntityType(
                typeof( LearningProgram ).FullName,
                0,
                Authorization.VIEW,
                true,
                RSR_ROCK_ADMINISTRATION_GUID,
                0,
                "A1F923D8-D3BF-4A72-BBC9-9AEDC3C3BA9C" );

            // LMS Worker: View.
            RockMigrationHelper.AddSecurityAuthForEntityType(
                typeof( LearningProgram ).FullName,
                0,
                Authorization.VIEW,
                true,
                RSR_LMS_WORKER_GUID,
                0,
                "BF394A67-2761-4FD9-AC19-FCDA0354159F" );

            // Staff: View.
            RockMigrationHelper.AddSecurityAuthForEntityType(
                typeof( LearningProgram ).FullName,
                0,
                Authorization.VIEW,
                true,
                RSR_STAFF_GUID,
                0,
                "AED1C50A-7758-40AB-A8B1-AAD7D2004017" );

            // Staff-Like Workers: View.
            RockMigrationHelper.AddSecurityAuthForEntityType(
                typeof( LearningProgram ).FullName,
                0,
                Authorization.VIEW,
                true,
                RSR_STAFF_LIKE_GUID,
                0,
                "281DB12F-B762-41F2-95F0-57C1010A38AF" );

            RockMigrationHelper.AddSecurityAuthForEntityType(
                typeof( LearningProgram ).FullName,
                1,
                Authorization.VIEW,
                false,
                null,
                ( int ) SpecialRole.AllUsers,
                "4DF13B7F-6B1A-4102-830B-5F8B27F87CA9" );
        }

        private void AddAttendancePages()
        {
            var classDetailPageGuid = "23D5076E-C062-4987-9985-B3A4792BF3CE";
            var classAttendanceListPageGuid = "C96E184D-62CB-4E6B-A53D-496903240E25";
            var classAttendanceDetailPageGuid = "463F18E2-C575-4EA8-A458-DB768419F3B3";

            var classDetailBlockId = "C67D2164-33E5-46C0-94EF-DF387EF8477D";
            var attendancePageAttributeGuid = "B417E2A7-BBA1-453F-9933-3BE439CD2063";
            var detailPageAttributeGuid = "15299237-7F47-404D-BEFF-460F7818D3D7";

            var classAttendanceListRouteGuid = "D8595643-6703-4B18-B9F6-0D213D86ED47";
            var classAttendanceDetailRouteGuid = "1E296771-03DE-4D63-8851-EDC817791C0D";
            var groupAttendanceDetailBlockTypeGuid = "308DBA32-F656-418E-A019-9D18235027C1";
            var classAttendanceListBlockGuid = "5D01D91F-0AED-4955-96BE-E5309488BC74";
            var classAttendanceDetailBlockGuid = "BDB64C4D-392E-419B-96F2-6556652C958A";

            // Add the Attendance list and detail pages, routes and blocks.
            RockMigrationHelper.AddPage( true, classDetailPageGuid, SystemGuid.Layout.FULL_WIDTH_INTERNAL_SITE, "Attendance List", "", classAttendanceListPageGuid, "", "" );
            RockMigrationHelper.AddPage( true, classAttendanceListPageGuid, SystemGuid.Layout.FULL_WIDTH_INTERNAL_SITE, "Attendance Detail", "", classAttendanceDetailPageGuid, "", "" );

            RockMigrationHelper.AddOrUpdatePageRoute( classAttendanceListPageGuid, "people/learn/{LearningProgramId}/courses/{LearningCourseId}/classes/{LearningClassId}/attendance", classAttendanceListRouteGuid );
            RockMigrationHelper.AddOrUpdatePageRoute( classAttendanceDetailPageGuid, "people/learn/{LearningProgramId}/courses/{LearningCourseId}/classes/{LearningClassId}/attendance/{GroupId}", classAttendanceDetailRouteGuid );

            // Add Block Attribute Value
            //   Block: Learning Class Detail
            //   BlockType: Learning Class Detail
            //   Category: LMS
            //   Block Location: Page=Class, Site=Rock RMS
            //   Attribute: Attendance Page
            /*   Attribute Value:  */
            RockMigrationHelper.AddBlockAttributeValue( classDetailBlockId, attendancePageAttributeGuid, $"{classAttendanceListPageGuid},{classAttendanceListRouteGuid}" );

            // Add Block 
            //  Block Name: Group Attendance Detail
            //  Page Name: Class Attendance
            //  Layout: -
            //  Site: Rock RMS
            RockMigrationHelper.AddBlock( true, classAttendanceListPageGuid.AsGuid(), null, SystemGuid.Site.SITE_ROCK_INTERNAL.AsGuid(), Rock.SystemGuid.BlockType.GROUP_ATTENDANCE_LIST.AsGuid(), "Attendance List", "Main", @"", @"", 0, classAttendanceListBlockGuid );

            // Add Block Attribute Value
            //   Block: Group Attendance List
            //   BlockType: Group Attendance List
            //   Category: LMS
            //   Block Location: Page=Attendance List, Site=Rock RMS
            //   Attribute: Detail Page
            /*   Attribute Value:  */
            RockMigrationHelper.AddBlockAttributeValue( classAttendanceListBlockGuid, detailPageAttributeGuid, $"{classAttendanceDetailPageGuid},{classAttendanceDetailRouteGuid}" );

            // Add Block 
            //  Block Name: Group Attendance Detail
            //  Page Name: Class Attendance
            //  Layout: -
            //  Site: Rock RMS
            RockMigrationHelper.AddBlock( true, classAttendanceDetailPageGuid.AsGuid(), null, SystemGuid.Site.SITE_ROCK_INTERNAL.AsGuid(), groupAttendanceDetailBlockTypeGuid.AsGuid(), "Attendance Detail", "Main", @"", @"", 0, classAttendanceDetailBlockGuid );
        }
    }
}
