<template>
    <NotificationBox v-if="!hasData" alertType="info">There are no computed tithing metrics.</NotificationBox>
    <Panel v-else title="Tithing Overview By Campus" type="block">
        <template #headerActions>
            <div class="control-wrapper mr-3">
                <div class="toggle-container">
                    <div class="btn-group btn-toggle btn-group-sm">
                        <RockButton :class="isToggled ? onButtonSelectedClasses : unselectedClasses" @click="onChartTypeClick(ChartTypeKey.BarChart)">
                            <i class="icon-fw fa fa-chart-bar"></i>
                        </RockButton>
                        <RockButton :class="isToggled ? unselectedClasses : offButtonSelectedClasses" @click="onChartTypeClick(ChartTypeKey.LineChart)">
                            <i class="icon-fw fa fa-chart-area"></i>
                        </RockButton>
                    </div>
                </div>
            </div>
        </template>
        <template #default>
            <div style="height: 500px; width: 98%;">
                <Chart :type="chartType" :data="chartData" :options="options" />
            </div>
        </template>
    </Panel>
</template>

<script setup lang="ts">
    import { computed, ref } from "vue";
    import { useInvokeBlockAction } from "@Obsidian/Utility/block";
    import RockButton from "@Obsidian/Controls/rockButton.obs";
    import Panel from "@Obsidian/Controls/panel.obs";
    import Chart from "@Obsidian/Controls/chart.obs";
    import NotificationBox from "@Obsidian/Controls/notificationBox.obs";
    import { ChartData, ChartOptions, ChartDataset, ChartEvent, LegendElement, LegendItem, Chart as ChartInstance, ChartType } from "@Obsidian/Libs/chart";
    import { onConfigurationValuesChanged, useConfigurationValues, useReloadBlock } from "@Obsidian/Utility/block";
    import { TithingOverviewInitializationBox } from "@Obsidian/ViewModels/Blocks/Reporting/TithingOverview/tithingOverviewInitializationBox";
    import { ChartTypeValue, ChartTypeKey, CampusAgeRangeKey } from "./TithingOverview/types.partial";
    import { TithingOverviewToolTipBag } from "@Obsidian/ViewModels/Blocks/Reporting/TithingOverview/tithingOverviewToolTipBag";
    import { RockDateTime } from "@Obsidian/Utility/rockDateTime";

    const config = useConfigurationValues<TithingOverviewInitializationBox>();

    // #region Values

    const chartData = ref<ChartData>(JSON.parse(config.chartDataJson || "{}"));
    const chartType = ref<ChartTypeValue>(config.chartType as ChartTypeValue);
    const toolTipData = ref(config.toolTipData ?? {});
    const legendLabelColorMap = ref(config.legendData ?? {
        "0-2 yrs": "#BAE6FD",
        "3-6 yrs": "#38BDF8",
        "7-11 yrs": "#0284C7",
        "11+": "#075985",
        "Unknown": "#A3A3A3",
    });
    const hasData = ref(config.hasData);

    const options = ref<ChartOptions>({
        responsive: true,
        maintainAspectRatio: false,
        datasets: {
            bar: {
                barPercentage: 0.5,
                categoryPercentage: 0.8
            },
            line: {
                fill: false
            }
        },
        animation: {
            duration: 1000
        },
        plugins: {
            legend: {
                position: "bottom",
                align: "start",
                display: true,
                labels: {
                    generateLabels: generateLegendLabels
                },
                onClick: legendClickHandler
            },
            tooltip: {
                enabled: false,
                external: createToolTip,
            }
        },
        scales: {
            y: {
                ticks: {
                    callback: function (label, _index, _labels) {
                        const date = Number(label);
                        if (date) {
                            return Intl.NumberFormat().format(date);
                        }
                        else {
                            return label;
                        }
                    },
                    stepSize: 1
                },
                stacked: false,
                beginAtZero: true,

                title: {
                    display: true,
                    text: "Tithing Households (%)"
                }
            }
        }
    });

    const invokeBlockAction = useInvokeBlockAction();

    const selectedClasses = "active btn btn-default";
    const unselectedClasses = "btn btn-default";
    const onButtonSelectedClasses = `${selectedClasses}`;
    const offButtonSelectedClasses = `${selectedClasses}`;

    // #endregion

    // #region Computed Values

    const isToggled = computed((): boolean => {
        return chartType.value == ChartTypeKey.BarChart;
    });

    // #endregion

    // #region Functions

    /**
     * Switches the Chart Type from Bar to Line based on the selected button.
     * @param selectedChartType
     */
    async function onChartTypeClick(selectedChartType: ChartTypeValue): Promise<void> {

        const result = await invokeBlockAction<TithingOverviewInitializationBox>("ChartData", {
            chartType: selectedChartType
        });

        if (result.isSuccess && result.data) {
            chartData.value = JSON.parse(result.data.chartDataJson || "{}") as ChartData;
            chartType.value = selectedChartType;
            toolTipData.value = result.data.toolTipData ?? {};
        }
        else {
            chartData.value = {} as ChartData;
        }
    }

    /**
     * Creates the tool tip html element for the chart data points.
     * @param context The tool tip context.
     */
    function createToolTip(context): void {

        // Tooltip Element
        let tooltipEl = document.getElementById("chartjs-tooltip");

        // Create element on first render
        if (!tooltipEl) {
            tooltipEl = document.createElement("div");
            tooltipEl.id = "chartjs-tooltip";
            tooltipEl.innerHTML = "<table></table>";
            document.body.appendChild(tooltipEl);
        }

        // Hide if no tooltip
        const tooltipModel = context.tooltip;

        if (tooltipModel.opacity === 0) {
            tooltipEl.style.opacity = "0";
            return;
        }

        tooltipEl.style.backgroundColor = "rgba(0, 0, 0, 0.5)";
        tooltipEl.style.borderRadius = "10px";
        tooltipEl.style.padding = "20px";
        tooltipEl.style.color = "white";
        // Set caret Position
        tooltipEl.classList.remove("above", "below", "no-transform");
        if (tooltipModel.yAlign) {
            tooltipEl.classList.add(tooltipModel.yAlign);
        }
        else {
            tooltipEl.classList.add("no-transform");
        }

        // Set Text
        if (tooltipModel.body) {
            const dataPoint = tooltipModel.dataPoints[0];
            const label = dataPoint.dataset?.label ?? "";

            let innerHtml = "";
            if (config.toolTipData) {
                const toolTipInfo = toolTipData.value[label];
                innerHtml += `<thead><tr><th>${toolTipInfo.campus}</th></tr></thead><tbody>`;

                if (chartType.value == ChartTypeKey.BarChart) {
                    innerHtml += `<tr><td><span style="border-width: 2px">Tithe Metric : ${toolTipInfo.titheMetric}</span></td><tr>`;
                    innerHtml += `<tr><td><span style="border-width: 2px">Campus Age : ${formatAge(toolTipInfo.campusOpenedDate, toolTipInfo.campusClosedDate)}</span></td><tr>`;
                    innerHtml += `<tr><td><span style="border-width: 2px">Giving Households : ${toolTipInfo.givingHouseHolds}</span></td><tr>`;
                    innerHtml += `<tr><td><span style="border-width: 2px">Tithing Households : ${toolTipInfo.tithingHouseHolds} | ${toolTipInfo.value}%</span></td><tr>`;
                }
                else {
                    innerHtml += `<tr><td><span style="border-width: 2px">Tithe Metric : ${toolTipInfo.date} - ${toolTipInfo.value}%</span></td><tr>`;
                }

                innerHtml += "</tbody>";
            }

            let tableRoot = tooltipEl.querySelector("table");
            if (tableRoot) {
                tableRoot.innerHTML = innerHtml;
            }
        }

        const position = context.chart.canvas.getBoundingClientRect();

        // Display, position, and set styles for font
        tooltipEl.style.opacity = "1";
        tooltipEl.style.position = "absolute";
        tooltipEl.style.left = position.left + window.pageXOffset + tooltipModel.caretX + "px";
        tooltipEl.style.top = position.top + window.pageYOffset + tooltipModel.caretY + "px";
        tooltipEl.style.pointerEvents = "none";
    }

    /**
     * Generates legend Items based on the Chart Type, in Bar mode campus age ranges are used as legend items,
     * in Line mode the Campuses are used as legend items.
     * @param chart
     */
    function generateLegendLabels(chart: ChartInstance): LegendItem[] {
        let legendItems = [] as LegendItem[];

        if (chartType.value == ChartTypeKey.BarChart) {
            for (const label in legendLabelColorMap.value) {
                let legendItem = {
                    text: label,
                    fillStyle: legendLabelColorMap.value[label]
                } as LegendItem;

                legendItems.push(legendItem);
            }
        }
        else {
            const datasets = chart.data.datasets ?? [];

            for (const dataset of datasets) {
                let legendItem = {
                    text: dataset.label,
                    fillStyle: dataset.borderColor,
                    datasetIndex: datasets.indexOf(dataset)
                } as LegendItem;

                legendItems.push(legendItem);
            }
        }

        return legendItems;
    }

    /**
     * Handles the legend click event by toggling the visibility of bars/lines in the chart that match the selected legend.
     * @param e The ChartEvent
     * @param legendItem The selected LegendItem
     * @param legend The LegendElement
     */
    function legendClickHandler(e: ChartEvent, legendItem: LegendItem, legend: LegendElement<ChartType>): void {
        const chart = legend.chart as ChartInstance;
        const datasets = chart.data.datasets;
        const legendLabel = legendItem.text as CampusAgeRangeKey;
        const selectedDatasets: ChartDataset[] = [];

        if (chartType.value === ChartTypeKey.BarChart) {
            // Filter datasets based on campus age range
            for (const key in toolTipData.value) {
                const data = toolTipData.value[key] as TithingOverviewToolTipBag;
                const campusAge = data.campusAge;

                // The legendLabel in bar mode is a range of ages, if the campus's age falls within the selected range
                // select that dataset for hiding.
                if (campusAgeInRange(campusAge, legendLabel) || data.campusShortCode === legendLabel) {
                    selectedDatasets.push(...datasets.filter(d => d.label === data.campus || d.label === data.campusShortCode));
                }
            }
        }
        else {
            // For line charts, directly filter by label
            selectedDatasets.push(...datasets.filter(d => d.label === legendLabel));
        }

        // Toggle dataset visibility
        selectedDatasets.forEach(dataset => {
            dataset.hidden = dataset.hidden === undefined ? !dataset.hidden : undefined;
            legendItem.hidden = true;
        });
    }

    /**
     * Checks if the campus age is within the specified range.
     */
    function campusAgeInRange(age: number | null | undefined, range: CampusAgeRangeKey): boolean {

        if (age == null || age == undefined) {
            return range == CampusAgeRangeKey.Unknown ? true : false;
        }

        switch (range) {
            case CampusAgeRangeKey.ZeroToTwo:
                return age >= 0 && age <= 2;
            case CampusAgeRangeKey.ThreeToSix:
                return age >= 3 && age <= 6;
            case CampusAgeRangeKey.SevenToEleven:
                return age >= 7 && age <= 11;
            case CampusAgeRangeKey.ElevenPlus:
                return age >= 11;
            case CampusAgeRangeKey.Unknown:
                return age == null || age == undefined;
            default:
                return false;
        }
    }

    /**
     * Creates a readble text version of the campus age in years.
     * @param age
     */
    function formatAge(openedDate: string | null | undefined, closedDate: string | null | undefined): string {

        if (!openedDate) {
            return "Unknown";
        }

        const startDate = RockDateTime.parseISO(openedDate);
        const endDate = !closedDate ? RockDateTime.now() : RockDateTime.parseISO(closedDate) ?? RockDateTime.now();

        if (!startDate) {
            return "Unknown";
        }

        const diffInMilliseconds = Math.abs(endDate.toMilliseconds() - startDate.toMilliseconds());
        const diffInSeconds = diffInMilliseconds / 1000;
        const diffInMinutes = diffInSeconds / 60;
        const diffInHours = diffInMinutes / 60;
        const diffInDays = diffInHours / 24;
        const diffInWeeks = diffInDays / 7;
        const diffInMonths = diffInDays / 30;
        const diffInYears = diffInDays / 365;

        if (diffInDays < 7) {
            return `${Math.floor(diffInDays)} days`;
        }
        else if (diffInDays < 30) {
            return `${Math.floor(diffInWeeks)} weeks`;
        }
        else if (diffInDays < 365) {
            return `${Math.floor(diffInMonths)} months`;
        }
        else {
            return `${Math.floor(diffInYears)} years`;
        }
    }

    // #endregion

    onConfigurationValuesChanged(useReloadBlock());

</script>