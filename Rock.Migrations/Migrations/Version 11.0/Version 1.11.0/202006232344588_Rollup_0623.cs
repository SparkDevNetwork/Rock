// <copyright>
// Copyright by the Spark Development Network
//
// Licensed under the Rock Community License (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
// http://www.rockrms.com/license
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.
// </copyright>
//
namespace Rock.Migrations
{
    using System;
    using System.Data.Entity.Migrations;
    using System.Web.Hosting;
    using System.IO;

    /// <summary>
    ///
    /// </summary>
    public partial class Rollup_0623 : Rock.Migrations.RockMigration
    {
        /// <summary>
        /// Operations to be performed during the upgrade process.
        /// </summary>
        public override void Up()
        {
            CodeGenMigrationsUp();
            EditLegacySendGridPluginWebhook();
        }
        
        /// <summary>
        /// Operations to be performed during the downgrade process.
        /// </summary>
        public override void Down()
        {
            CodeGenMigrationsDown();
        }

        /// <summary>
        /// Edits the legacy SendGrid plug-in webhook (if it exists) to replace
        /// the occurrence of "c.ChannelId ==" with "c.InteractionChannelId =="
        /// so that the webhook will continue to function until the admin
        /// replaces it with the new core webhook.
        /// </summary>
        public void EditLegacySendGridPluginWebhook()
        {
            // We'll take a stab at editing the file to give the admin some 
            // grace period to remove/replace the old plugin with the one in
            // Rock core.
            try
            {
                string webhook = HostingEnvironment.MapPath( "~/Webhooks/SendGrid.ashx" );
                if ( File.Exists( webhook ) )
                {
                    System.IO.File.WriteAllText( webhook, System.Text.RegularExpressions.Regex.Replace( File.ReadAllText( webhook ), "c.ChannelId ==", "c.InteractionChannelId ==" ) );
                }
            }
            catch { }
        }

        /// <summary>
        /// Script generated "Up" migrations for pages, blocks, and block attributes.
        /// </summary>
        private void CodeGenMigrationsUp()
        {
            // Add/Update Mobile Block Type:Structured Content View
            RockMigrationHelper.UpdateMobileBlockType("Structured Content View", "Displays a structured content channel item for the user to view and fill out.", "Rock.Blocks.Types.Mobile.Cms.StructuredContentView", "Mobile > Cms", "321ECC9A-18F2-44C0-8751-93D3A43E0C3E");

            // Add/Update Mobile Block Type:Calendar Event Item Occurrence View
            RockMigrationHelper.UpdateMobileBlockType("Calendar Event Item Occurrence View", "Displays a particular calendar event item occurrence.", "Rock.Blocks.Types.Mobile.Events.CalendarEventItemOccurrenceView", "Mobile > Events", "4F28A265-258F-4EEB-8EFD-8166BAF6E0C4");

            // Attribute for BlockType: Calendar Event Item Occurrence View:Registration Url
            RockMigrationHelper.AddOrUpdateBlockTypeAttribute( "4F28A265-258F-4EEB-8EFD-8166BAF6E0C4", "9C204CD0-1233-41C5-818A-C5DA439445AA", "Registration Url", "RegistrationUrl", "Registration Url", @"The base URL to use when linking to the registration page.", 0, @"", "EDD2F50E-FBE6-4CB2-A80F-272981BC9BE0" );

            // Attribute for BlockType: Calendar Event Item Occurrence View:Template
            RockMigrationHelper.AddOrUpdateBlockTypeAttribute( "4F28A265-258F-4EEB-8EFD-8166BAF6E0C4", "CCD73456-C83B-4D6E-BD69-8133D2EB996D", "Template", "Template", "Template", @"The template to use when rendering the event.", 1, @"6593D4EB-2B7A-4C24-8D30-A02991D26BC0", "EE3FFF65-AE5F-4C58-9480-A886286BE78F" );
        }

        /// <summary>
        /// Script generated "Down" migrations for pages, blocks, and block attributes.
        /// </summary>
        private void CodeGenMigrationsDown()
        {
            // Template Attribute for BlockType: Calendar Event Item Occurrence View
            RockMigrationHelper.DeleteAttribute("EE3FFF65-AE5F-4C58-9480-A886286BE78F");

            // Registration Url Attribute for BlockType: Calendar Event Item Occurrence View
            RockMigrationHelper.DeleteAttribute("EDD2F50E-FBE6-4CB2-A80F-272981BC9BE0");

            // Delete BlockType Calendar Event Item Occurrence View
            RockMigrationHelper.DeleteBlockType("4F28A265-258F-4EEB-8EFD-8166BAF6E0C4"); // Calendar Event Item Occurrence View

            // Delete BlockType Structured Content View
            RockMigrationHelper.DeleteBlockType("321ECC9A-18F2-44C0-8751-93D3A43E0C3E"); // Structured Content View
        }
    }
}
