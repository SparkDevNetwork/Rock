// <copyright>
// Copyright by the Spark Development Network
//
// Licensed under the Rock Community License (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
// http://www.rockrms.com/license
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.
// </copyright>
//
namespace Rock.Migrations
{
    using System;
    using System.Data.Entity.Migrations;
    
    /// <summary>
    ///
    /// </summary>
    public partial class Rollup_0621 : Rock.Migrations.RockMigration
    {
        /// <summary>
        /// Operations to be performed during the upgrade process.
        /// </summary>
        public override void Up()
        {
            ZplLabelEncoding();
            AddSlugRoutes();
            HistoryLog();
        }
        
        /// <summary>
        /// Operations to be performed during the downgrade process.
        /// </summary>
        public override void Down()
        {
        }

        private void ZplLabelEncoding()
        {
            //Child Label (Text)
            Sql( @"UPDATE BinaryFileData
                SET [Content] = 0x1043547E7E43442C7E43435E7E43547E0A5E58417E54413030307E4A534E5E4C54305E4D4E575E4D54445E504F4E5E504D4E5E4C48302C305E4A4D415E5052362C367E534431355E4C524E5E434932385E585A0A5E58410A5E4D4D540A5E50573831320A5E4C4C303430360A5E4C53300A5E46543434332C3131395E41304E2C3133352C3133345E46423333332C312C302C525E46485C5E46445757575E46530A5E4654352C3234385E41304E2C3133352C3134365E46485C5E4644355E46530A5E4654342C3330335E41304E2C34352C34355E46485C5E4644365E46530A5E464F3632362C3334305E474237382C35362C35365E46530A5E46543632362C3338345E41304E2C34352C34355E464237382C312C302C435E46525E46485C5E46444141415E46530A5E464F3731392C3334305E474236362C35362C35365E46530A5E46543731392C3338345E41304E2C34352C34355E464236362C312C302C435E46525E46485C5E46444C4C4C5E46530A5E46543333362C3130335E41304E2C3130322C3130305E46485C5E4644325E46530A5E46543430312C3130335E41304E2C3130322C3130305E46485C5E4644335E46530A5E46543334322C3133305E41304E2C32382C32385E46485C5E4644345E46530A5E46423333302C322C302C4C5E4654382C3338325E41304E2C32382C32385E46485C5E4644395E46530A5E4C52595E464F302C305E47423831322C302C3133365E46535E4C524E0A5E5051312C302C312C595E585A0A
                WHERE [Id] = (SELECT [Id] FROM BinaryFile WHERE [Guid] = '1B31A2A3-6438-4557-8788-7F057A025EAA')" );

            //Name Tag
            Sql( @"UPDATE BinaryFileData
                SET [Content] = 0x1043547E7E43442C7E43435E7E43547E0A5E58417E54413030307E4A534E5E4C54305E4D4E575E4D54445E504F4E5E504D4E5E4C48302C305E4A4D415E5052362C367E534432345E4C524E5E434932385E585A0A5E58410A5E4D4D540A5E50573831320A5E4C4C303430360A5E4C53300A5E465431362C3235365E41304E2C3133352C3134365E46485C5E46444E69636B4E616D655E46530A5E465431382C3332385E41304E2C35362C35355E46485C5E46444C6173744E616D655E46530A5E4C52595E464F302C305E47423831322C302C3132325E46535E4C524E0A5E5051312C302C312C595E585A0A
                WHERE [Id] = (SELECT [Id] FROM BinaryFile WHERE [Guid] = '918F55A6-BD4B-4070-9017-D5FC5207653E')" );

            //Note Label
            Sql( @"UPDATE BinaryFileData
                SET [Content] = 0x1043547E7E43442C7E43435E7E43547E0A5E58417E54413030307E4A534E5E4C54305E4D4E575E4D54445E504F4E5E504D4E5E4C48302C305E4A4D415E5052362C367E534431355E4C524E5E434932385E585A0A5E58410A5E4D4D540A5E50573831320A5E4C4C303430360A5E4C53300A5E46543630372C36385E41304E2C37332C37325E46423137372C312C302C525E46485C5E46445757575E46530A5E4654362C3132325E41304E2C33392C33385E46485C5E4644325E46530A5E464F382C3136315E474235372C34322C34325E46530A5E4654382C3139345E41304E2C33342C33335E464235372C312C302C435E46525E46485C5E46444141415E46530A5E46423333302C332C302C4C5E46543432372C3136385E41304E2C32352C32345E46485C5E4644335E46530A5E464F31322C3236345E474234382C34322C34325E46530A5E465431322C3239375E41304E2C33342C33335E464234382C312C302C435E46525E46485C5E46444C4C4C5E46530A5E46423333302C342C302C4C5E465436382C3235305E41304E2C32332C32345E46485C5E4644355E46530A5E46423333302C342C302C4C5E465436382C3335345E41304E2C32332C32345E46485C5E4644375E46530A5E46543432312C3231325E41304E2C32332C32345E46485C5E46444E6F7465733A5E46530A5E464F3430332C3135345E4742302C3233372C315E46530A5E464F3432322C3338365E47423336312C302C315E46530A5E464F3432332C3334355E47423336312C302C315E46530A5E464F3432312C3330345E47423336312C302C315E46530A5E464F3432312C3236335E47423336312C302C315E46530A5E4C52595E464F302C305E47423831322C302C38315E46535E4C524E0A5E5051312C302C312C595E585A0A
                WHERE [Id] = (SELECT [Id] FROM BinaryFile WHERE [Guid] = '50E743E2-76C1-428F-8072-E9BC157D0A08')" );

            //Parent Label
            Sql( @"UPDATE BinaryFileData
                SET [Content] = 0x1043547E7E43442C7E43435E7E43547E0A5E58417E54413030307E4A534E5E4C54305E4D4E575E4D54445E504F4E5E504D4E5E4C48302C305E4A4D415E5052362C367E534431355E4C524E5E434932385E585A0A5E58410A5E4D4D540A5E50573831320A5E4C4C303430360A5E4C53300A5E465432302C38305E41304E2C37332C37325E46423830302C302C302C4C5E46485C5E46444368696C64205069636B757020526563656970745E46530A5E46423335302C372C302C4C5E465433302C3339305E41304E2C33392C33385E4644315E46530A5E46423335302C372C302C4C5E46543431352C3339305E41304E2C33392C33385E4644325E46530A5E465431342C3336395E41304E2C32332C32345E46485C5E4644466F722074686520736166657479206F6620796F7572206368696C642C20796F75206D7573742070726573656E7420746869732072656365697074207768656E207069636B696E675E46530A5E465431352C3339335E41304E2C32332C32345E46485C5E4644757020796F7572206368696C642E20496620796F75206C6F7365207468697320706C6561736520736565207468652061726561206469726563746F722E5E46530A5E4C52595E464F302C305E47423831322C302C3130305E46535E4C524E0A5E5051312C302C312C595E585A
                WHERE [Id] = (SELECT [Id] FROM BinaryFile WHERE [Guid] = '9B098DB0-952C-43FB-A5BD-511E3C2B72FB')" );

            //Child Label (Icon)
            Sql( @"UPDATE BinaryFileData
                SET [Content] = 0x1043547E7E43442C7E43435E7E43547E0A5E58417E54413030307E4A534E5E4C54305E4D4E575E4D54445E504F4E5E504D4E5E4C48302C305E4A4D415E5052362C367E534432345E4C524E5E434932385E585A0A5E58410A5E4D4D540A5E50573831320A5E4C4C303430360A5E4C53300A5E46543435322C3131395E41304E2C3133352C3133345E46423333332C312C302C525E46485C5E46445757575E46530A5E465431322C3235345E41304E2C3133352C3134365E46485C5E4644355E46530A5E465431342C3330395E41304E2C34352C34355E46485C5E4644365E46530A5E43575A2C453A524F433030302E464E545E46543239332C38325E415A4E2C37332C37330A5E46485C5E4644425E46530A5E43575A2C453A524F433030302E464E545E46543337382C38315E415A4E2C37332C37330A5E46485C5E4644465E46530A5E46543239392C3132305E41304E2C32382C32385E46485C5E4644345E46530A5E46423333302C322C302C4C5E4654382C3338325E41304E2C32382C32385E46485C5E4644395E46530A5E43575A2C453A524F433030302E464E545E46543630352C3338335E415A4E2C37332C37335E46485C5E4644375E46530A5E43575A2C453A524F433030302E464E545E46543731352C3338365E415A4E2C37332C37335E46485C5E4644385E46530A5E4C52595E464F302C305E47423831322C302C3133365E46535E4C524E0A5E5051312C302C312C595E585A0A
                WHERE [Id] = (SELECT [Id] FROM BinaryFile WHERE [Guid] = 'C2E6B0A0-3991-4FAF-9E2F-49CF321CBB0D')" );
        }

        private void AddSlugRoutes()
        {
            // Create Blog Route
            Sql( @"
                DECLARE @PageId int = (SELECT TOP 1 p.[Id]
	                FROM [Page] p
	                JOIN [Block] b ON p.[Id] = b.[PageId]
	                JOIN [Layout] l ON p.LayoutId = l.[Id]
	                JOIN [Site] s ON l.SiteId = s.[Id]
	                WHERE p.[Guid] = '4857A6C9-F194-4B64-A9FB-6A8DC7A1A671'
		                AND p.CreatedDateTime IS NULL
		                AND p.ModifiedDateTime IS NULL
		                AND b.[Zone] = 'Main'
		                AND b.[CreatedDateTime] IS NULL
		                AND b.[ModifiedDateTime] IS NULL
		                AND s.Theme IN ('Stark', 'Flat'))

                IF @PageId IS NOT NULL
                BEGIN
                    IF NOT EXISTS(SELECT [Id] FROM [PageRoute] WHERE [PageId] = @PageId AND [Route] = 'blog')
	                BEGIN
                        INSERT INTO [PageRoute] ([IsSystem],[PageId],[Route],[Guid])
                        VALUES(1, @PageId, 'blog', '8D031C06-26B9-4975-8275-C27386416FCF')
				
	                END
                END" );

            // blog/{Slug} route for Blog Details page
            Sql( @"
                DECLARE @PageId int = (SELECT TOP 1 p.[Id]
	                FROM [Page] p
	                JOIN [Block] b ON p.[Id] = b.[PageId]
	                JOIN [Layout] l ON p.LayoutId = l.[Id]
	                JOIN [Site] s ON l.SiteId = s.[Id]
	                WHERE p.[Guid] = '2D0D0FB0-68C4-47E1-8BC6-98F931497F5E'
		                AND p.CreatedDateTime IS NULL
		                AND p.ModifiedDateTime IS NULL
		                AND b.[Zone] = 'Main'
		                AND b.[CreatedDateTime] IS NULL
		                AND b.[ModifiedDateTime] IS NULL
		                AND s.Theme IN ('Stark', 'Flat'))

                IF @PageId IS NOT NULL
                BEGIN
                    IF NOT EXISTS(SELECT [Id] FROM [PageRoute] WHERE [PageId] = @PageId AND [Route] = 'blog/{Slug}')
	                BEGIN
                        INSERT INTO [PageRoute] ([IsSystem],[PageId],[Route],[Guid])
                        VALUES(1, @PageId, 'blog/{Slug}', '27519066-3911-4AF4-8B88-91CF7244F6F6')

		                DECLARE @BlockId int = (SELECT [Id] FROM [Block] WHERE [Guid] = 'AE2D8454-AE86-40DF-A57A-C9F30B8AB50F')
                        DECLARE @AttributeId int = (SELECT [Id] FROM [Attribute] WHERE [Guid] = '2D7E6F55-B25E-4EA2-8F7E-F7E138E39E21')

                        IF @BlockId IS NOT NULL AND @AttributeId IS NOT NULL
		                BEGIN
			                DECLARE @TheValue NVARCHAR(MAX) = '2d0d0fb0-68c4-47e1-8bc6-98f931497f5e,27519066-3911-4af4-8b88-91cf7244f6f6'
                    
                            DELETE [AttributeValue] WHERE [AttributeId] = @AttributeId AND [EntityId] = @BlockId

                            INSERT INTO [AttributeValue] ([IsSystem], [AttributeId], [EntityId], [Value], [Guid])
                            VALUES(1, @AttributeId, @BlockId, @TheValue, NEWID())
                        END
	                END
                END" );


            // Create Promo Routes
            Sql( @"
            DECLARE @PageId int = (SELECT TOP 1 p.[Id]
	            FROM [Page] p
	            JOIN [Block] b ON p.[Id] = b.[PageId]
	            JOIN [Layout] l ON p.LayoutId = l.[Id]
	            JOIN [Site] s ON l.SiteId = s.[Id]
	            WHERE p.[Guid] = '56F1DC05-3D7D-49B6-9A30-5CF271C687F4'
		            AND p.CreatedDateTime IS NULL
		            AND p.ModifiedDateTime IS NULL
		            AND b.[Zone] = 'Main'
		            AND b.[CreatedDateTime] IS NULL
		            AND b.[ModifiedDateTime] IS NULL
		            AND s.Theme IN ('Stark', 'Flat'))

            IF @PageId IS NOT NULL
            BEGIN
                IF NOT EXISTS(SELECT [Id] FROM [PageRoute] WHERE [PageId] = @PageId AND [Route] = 'promo/{Slug}')
	            BEGIN
                    INSERT INTO [PageRoute] ([IsSystem],[PageId],[Route],[Guid])
                    VALUES(1, @PageId, 'promo/{Slug}', 'CA585A73-FCE5-4B02-9894-62AF665D01E3')

		            DECLARE @BlockId int = (SELECT [Id] FROM [Block] WHERE [Guid] = '095027CB-9114-4CD5-ABE8-1E8882422DCF')
                    DECLARE @AttributeId int = (SELECT [Id] FROM [Attribute] WHERE [Guid] = '2D7E6F55-B25E-4EA2-8F7E-F7E138E39E21')
		            DECLARE @TheValue NVARCHAR(MAX) = '56f1dc05-3d7d-49b6-9a30-5cf271c687f4,ca585a73-fce5-4b02-9894-62af665d01e3'
            
                    IF @BlockId IS NOT NULL AND @AttributeId IS NOT NULL
		            BEGIN
			        
                        DELETE [AttributeValue] WHERE [AttributeId] = @AttributeId AND [EntityId] = @BlockId

                        INSERT INTO [AttributeValue] ([IsSystem], [AttributeId], [EntityId], [Value], [Guid])
                        VALUES(1, @AttributeId, @BlockId, @TheValue, NEWID())
                    END

		            SET @BlockId = (SELECT [Id] FROM [Block] WHERE [Guid] = '2E0FFD29-B4AF-4A5E-B528-667168762ABC')

                    IF @BlockId IS NOT NULL AND @AttributeId IS NOT NULL
		            BEGIN
                        DELETE [AttributeValue] WHERE [AttributeId] = @AttributeId AND [EntityId] = @BlockId

                        INSERT INTO [AttributeValue] ([IsSystem], [AttributeId], [EntityId], [Value], [Guid])
                        VALUES(1, @AttributeId, @BlockId, @TheValue, NEWID())
                    END
	            END
            END" );
        }

        /// <summary>
        /// MP: Replace PersonHistory Block with HistoryLog
        /// </summary>
        private void HistoryLog()
        {
            // Remove Block: Person History, from Page: History, Site: Rock Internal
            RockMigrationHelper.DeleteBlock( "F98649D7-E522-46CB-8F67-01DB7F59E3AA" );

            // Add Block to Page: History, Site: Rock RMS
            RockMigrationHelper.AddBlock( true, "BC8E5377-0F6C-457A-9CF0-0F0A0AB2A418", "", "C6C2DF41-A50D-4975-B21C-4EFD6FF3E8D0", "History Log", "SectionC1", @"", @"", 3, "F5BE2D28-C886-4357-9D2E-FE4D5BBBA700" );
            // update block order for pages with new blocks if the page,zone has multiple blocks
            Sql( @"UPDATE [Block] SET [Order] = 0 WHERE [Guid] = '27F84ADB-AA13-439E-A130-FBF73698B172'" );  // Page: History,  Zone: SectionC1,  Block: Communication History
            Sql( @"UPDATE [Block] SET [Order] = 1 WHERE [Guid] = '2D99AB97-4B9C-4D72-B207-8F36AE90D495'" );  // Page: History,  Zone: SectionC1,  Block: Attendance History
            Sql( @"UPDATE [Block] SET [Order] = 3 WHERE [Guid] = 'F5BE2D28-C886-4357-9D2E-FE4D5BBBA700'" );  // Page: History,  Zone: SectionC1,  Block: History Log
            Sql( @"UPDATE [Block] SET [Order] = 4 WHERE [Guid] = '69E78065-3BFC-452E-97C3-C104497CF7EB'" );  // Page: History,  Zone: SectionC1,  Block: Signature Document List

            // Attrib Value for Block:History Log, Attribute:Entity Type Page: History, Site: Rock RMS
            RockMigrationHelper.AddBlockAttributeValue( "F5BE2D28-C886-4357-9D2E-FE4D5BBBA700", "8FB690EC-5299-46C5-8695-AAD23168E6E1", @"72657ed8-d16e-492e-ac12-144c5e7567e7" );
            // Attrib Value for Block:History Log, Attribute:Heading Page: History, Site: Rock RMS
            RockMigrationHelper.AddBlockAttributeValue( "F5BE2D28-C886-4357-9D2E-FE4D5BBBA700", "614CD413-DCB7-4DA2-80A0-C7ABE5A11047", @"Person History" );
        }
    }
}
