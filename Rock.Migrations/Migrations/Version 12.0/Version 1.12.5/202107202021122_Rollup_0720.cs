// <copyright>
// Copyright by the Spark Development Network
//
// Licensed under the Rock Community License (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
// http://www.rockrms.com/license
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.
// </copyright>
//
namespace Rock.Migrations
{
    using System;
    using System.Data.Entity.Migrations;
    
    /// <summary>
    ///
    /// </summary>
    public partial class Rollup_0720 : Rock.Migrations.RockMigration
    {
        /// <summary>
        /// Operations to be performed during the upgrade process.
        /// </summary>
        public override void Up()
        {
            EnableAuditingGlobalAttributeDescription();
            FixMobileEventItemOccurrenceListByAudienceDefaultTempalteUp();
        }
        
        /// <summary>
        /// Operations to be performed during the downgrade process.
        /// </summary>
        public override void Down()
        {
        }

        /// <summary>
        /// NA: Update 'EnableAuditing' Global Attribute Description
        /// </summary>
        private void EnableAuditingGlobalAttributeDescription()
        {
            Sql( @"
                UPDATE [Attribute]
                SET [Description] = 'Enable the saving of audit information for every row/field change made in Rock. WARNING: Enabling will cause a significant impact to performance. Enable only for brief periods of troubleshooting/investigating.'
                WHERE [Guid] = '66B13C02-CBA0-4427-9D60-8B331A51CC96'
                    AND [Description] = 'Enable the saving of audit information for every row/field change made in Rock.'" );
        }

        /// <summary>
        /// DH: Fix Mobile Event Item Occurrence List By Audience Default Template
        /// </summary>
        private void FixMobileEventItemOccurrenceListByAudienceDefaultTempalteUp()
        {
            string STANDARD_ICON_SVG = "PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+CjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+Cjxzdmcgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgdmlld0JveD0iMCAwIDY0MCAyNDAiIHZlcnNpb249IjEuMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgeG1sOnNwYWNlPSJwcmVzZXJ2ZSIgeG1sbnM6c2VyaWY9Imh0dHA6Ly93d3cuc2VyaWYuY29tLyIgc3R5bGU9ImZpbGwtcnVsZTpldmVub2RkO2NsaXAtcnVsZTpldmVub2RkO3N0cm9rZS1saW5lam9pbjpyb3VuZDtzdHJva2UtbWl0ZXJsaW1pdDoyOyI+CiAgICA8ZyB0cmFuc2Zvcm09Im1hdHJpeCgxLjEwMTU1LDAsMCwxLC0zMC44NDM0LC0zMSkiPgogICAgICAgIDxyZWN0IHg9IjI4IiB5PSIzMSIgd2lkdGg9IjU4MSIgaGVpZ2h0PSIxOCIgc3R5bGU9ImZpbGw6cmdiKDIzMSwyMzEsMjMxKTsiLz4KICAgIDwvZz4KICAgIDxnIHRyYW5zZm9ybT0ibWF0cml4KDAuOTY1NTc3LDAsMCwxLC0yNy4wMzYxLDEyKSI+CiAgICAgICAgPHJlY3QgeD0iMjgiIHk9IjMxIiB3aWR0aD0iNTgxIiBoZWlnaHQ9IjE4IiBzdHlsZT0iZmlsbDpyZ2IoMjMxLDIzMSwyMzEpOyIvPgogICAgPC9nPgogICAgPGcgdHJhbnNmb3JtPSJtYXRyaXgoMS4wMjA2NSwwLDAsMSwtMjguNTc4Myw1NSkiPgogICAgICAgIDxyZWN0IHg9IjI4IiB5PSIzMSIgd2lkdGg9IjU4MSIgaGVpZ2h0PSIxOCIgc3R5bGU9ImZpbGw6cmdiKDIzMSwyMzEsMjMxKTsiLz4KICAgIDwvZz4KICAgIDxnIHRyYW5zZm9ybT0ibWF0cml4KDAuOTg0NTA5LDAsMCwxLC0yNy41NjYzLDk4KSI+CiAgICAgICAgPHJlY3QgeD0iMjgiIHk9IjMxIiB3aWR0aD0iNTgxIiBoZWlnaHQ9IjE4IiBzdHlsZT0iZmlsbDpyZ2IoMjMxLDIzMSwyMzEpOyIvPgogICAgPC9nPgogICAgPGcgdHJhbnNmb3JtPSJtYXRyaXgoMS4wNTY4LDAsMCwxLC0yOS41OTA0LDE0MSkiPgogICAgICAgIDxyZWN0IHg9IjI4IiB5PSIzMSIgd2lkdGg9IjU4MSIgaGVpZ2h0PSIxOCIgc3R5bGU9ImZpbGw6cmdiKDIzMSwyMzEsMjMxKTsiLz4KICAgIDwvZz4KICAgIDxnIHRyYW5zZm9ybT0ibWF0cml4KDEuMDc5MTcsMCwwLDEsLTMwLjIxNjksMTg0KSI+CiAgICAgICAgPHJlY3QgeD0iMjgiIHk9IjMxIiB3aWR0aD0iNTgxIiBoZWlnaHQ9IjE4IiBzdHlsZT0iZmlsbDpyZ2IoMjMxLDIzMSwyMzEpOyIvPgogICAgPC9nPgo8L3N2Zz4K";

            RockMigrationHelper.AddOrUpdateTemplateBlockTemplate( "323D1996-C27F-4B48-B0C7-82FDA440D950",
                Rock.SystemGuid.DefinedValue.BLOCK_TEMPLATE_MOBILE_EVENT_ITEM_OCCURRENCE_LIST_BY_AUDIENCE,
                "Default",
                @"<StackLayout>
    <Label StyleClass=""h1,mb-4"" Text=""{{ ListTitle | Escape }}"" />
    {% for occurrence in EventItemOccurrences %}
    <Frame HasShadow=""false"" StyleClass=""calendar-event"">
        <StackLayout Spacing=""0"">
            <Label StyleClass=""calendar-event-title"" Text=""{{ occurrence.EventItem.Name | Escape }}"" />
            <Label StyleClass=""calendar-event-text text-sm"" Text=""({{ occurrence.Schedule.iCalendarContent | DatesFromICal | First | Date: 'M/d ' }})"" LineBreakMode=""NoWrap"" />
        </StackLayout>
    
        {% if occurrence.EventItem.DetailsUrl != '' %}
            <Frame.GestureRecognizers>
                <TapGestureRecognizer Command=""{Binding OpenExternalBrowser}"" CommandParameter=""{{ occurrence.EventItem.DetailsUrl | Escape }}"" />
            </Frame.GestureRecognizers>
        {% elseif EventDetailPage != null %}
            <Frame.GestureRecognizers>
                <TapGestureRecognizer Command=""{Binding PushPage}"" CommandParameter=""{{ EventDetailPage }}?EventOccurrenceId={{ occurrence.Id }}&amp;EventOccurrenceGuid={{ occurrence.Guid }}"" />
            </Frame.GestureRecognizers>
        {% endif %}
    </Frame>
    {% endfor %}
</StackLayout>",
    STANDARD_ICON_SVG,
    "standard-template.svg",
    "image/svg+xml" );
        }
    }
}
